<!DOCTYPE html>
<html xmlns="http://www.w3.org/1999/xhtml" lang="en" xml:lang="en"><head>

<meta charset="utf-8">
<meta name="generator" content="quarto-1.2.269">

<meta name="viewport" content="width=device-width, initial-scale=1.0, user-scalable=yes">

<meta name="author" content="Johan de Aguas">

<title>ipw-selection - When selection depends on mediation: part 1</title>
<style>
code{white-space: pre-wrap;}
span.smallcaps{font-variant: small-caps;}
div.columns{display: flex; gap: min(4vw, 1.5em);}
div.column{flex: auto; overflow-x: auto;}
div.hanging-indent{margin-left: 1.5em; text-indent: -1.5em;}
ul.task-list{list-style: none;}
ul.task-list li input[type="checkbox"] {
  width: 0.8em;
  margin: 0 0.8em 0.2em -1.6em;
  vertical-align: middle;
}
pre > code.sourceCode { white-space: pre; position: relative; }
pre > code.sourceCode > span { display: inline-block; line-height: 1.25; }
pre > code.sourceCode > span:empty { height: 1.2em; }
.sourceCode { overflow: visible; }
code.sourceCode > span { color: inherit; text-decoration: inherit; }
div.sourceCode { margin: 1em 0; }
pre.sourceCode { margin: 0; }
@media screen {
div.sourceCode { overflow: auto; }
}
@media print {
pre > code.sourceCode { white-space: pre-wrap; }
pre > code.sourceCode > span { text-indent: -5em; padding-left: 5em; }
}
pre.numberSource code
  { counter-reset: source-line 0; }
pre.numberSource code > span
  { position: relative; left: -4em; counter-increment: source-line; }
pre.numberSource code > span > a:first-child::before
  { content: counter(source-line);
    position: relative; left: -1em; text-align: right; vertical-align: baseline;
    border: none; display: inline-block;
    -webkit-touch-callout: none; -webkit-user-select: none;
    -khtml-user-select: none; -moz-user-select: none;
    -ms-user-select: none; user-select: none;
    padding: 0 4px; width: 4em;
    color: #aaaaaa;
  }
pre.numberSource { margin-left: 3em; border-left: 1px solid #aaaaaa;  padding-left: 4px; }
div.sourceCode
  {   }
@media screen {
pre > code.sourceCode > span > a:first-child::before { text-decoration: underline; }
}
code span.al { color: #ff0000; font-weight: bold; } /* Alert */
code span.an { color: #60a0b0; font-weight: bold; font-style: italic; } /* Annotation */
code span.at { color: #7d9029; } /* Attribute */
code span.bn { color: #40a070; } /* BaseN */
code span.bu { color: #008000; } /* BuiltIn */
code span.cf { color: #007020; font-weight: bold; } /* ControlFlow */
code span.ch { color: #4070a0; } /* Char */
code span.cn { color: #880000; } /* Constant */
code span.co { color: #60a0b0; font-style: italic; } /* Comment */
code span.cv { color: #60a0b0; font-weight: bold; font-style: italic; } /* CommentVar */
code span.do { color: #ba2121; font-style: italic; } /* Documentation */
code span.dt { color: #902000; } /* DataType */
code span.dv { color: #40a070; } /* DecVal */
code span.er { color: #ff0000; font-weight: bold; } /* Error */
code span.ex { } /* Extension */
code span.fl { color: #40a070; } /* Float */
code span.fu { color: #06287e; } /* Function */
code span.im { color: #008000; font-weight: bold; } /* Import */
code span.in { color: #60a0b0; font-weight: bold; font-style: italic; } /* Information */
code span.kw { color: #007020; font-weight: bold; } /* Keyword */
code span.op { color: #666666; } /* Operator */
code span.ot { color: #007020; } /* Other */
code span.pp { color: #bc7a00; } /* Preprocessor */
code span.sc { color: #4070a0; } /* SpecialChar */
code span.ss { color: #bb6688; } /* SpecialString */
code span.st { color: #4070a0; } /* String */
code span.va { color: #19177c; } /* Variable */
code span.vs { color: #4070a0; } /* VerbatimString */
code span.wa { color: #60a0b0; font-weight: bold; font-style: italic; } /* Warning */
div.csl-bib-body { }
div.csl-entry {
  clear: both;
}
.hanging div.csl-entry {
  margin-left:2em;
  text-indent:-2em;
}
div.csl-left-margin {
  min-width:2em;
  float:left;
}
div.csl-right-inline {
  margin-left:2em;
  padding-left:1em;
}
div.csl-indent {
  margin-left: 2em;
}
</style>


<script src="site_libs/quarto-nav/quarto-nav.js"></script>
<script src="site_libs/quarto-nav/headroom.min.js"></script>
<script src="site_libs/clipboard/clipboard.min.js"></script>
<script src="site_libs/quarto-search/autocomplete.umd.js"></script>
<script src="site_libs/quarto-search/fuse.min.js"></script>
<script src="site_libs/quarto-search/quarto-search.js"></script>
<meta name="quarto:offset" content="./">
<script src="site_libs/quarto-html/quarto.js"></script>
<script src="site_libs/quarto-html/popper.min.js"></script>
<script src="site_libs/quarto-html/tippy.umd.min.js"></script>
<script src="site_libs/quarto-html/anchor.min.js"></script>
<link href="site_libs/quarto-html/tippy.css" rel="stylesheet">
<link href="site_libs/quarto-html/quarto-syntax-highlighting-dark.css" rel="stylesheet" id="quarto-text-highlighting-styles">
<script src="site_libs/bootstrap/bootstrap.min.js"></script>
<link href="site_libs/bootstrap/bootstrap-icons.css" rel="stylesheet">
<link href="site_libs/bootstrap/bootstrap.min.css" rel="stylesheet" id="quarto-bootstrap" data-mode="dark">
<script id="quarto-search-options" type="application/json">{
  "location": "navbar",
  "copy-button": false,
  "collapse-after": 3,
  "panel-placement": "end",
  "type": "overlay",
  "limit": 20,
  "language": {
    "search-no-results-text": "No results",
    "search-matching-documents-text": "matching documents",
    "search-copy-link-title": "Copy link to search",
    "search-hide-matches-text": "Hide additional matches",
    "search-more-match-text": "more match in this document",
    "search-more-matches-text": "more matches in this document",
    "search-clear-button-title": "Clear",
    "search-detached-cancel-button-title": "Cancel",
    "search-submit-button-title": "Submit"
  }
}</script>

<script src="site_libs/kePrint-0.0.1/kePrint.js"></script>
<link href="site_libs/lightable-0.0.1/lightable.css" rel="stylesheet">

  <script src="https://cdn.jsdelivr.net/npm/mathjax@3/es5/tex-chtml-full.js" type="text/javascript"></script>

<link rel="stylesheet" href="styles.css">
</head>

<body class="nav-fixed">

<div id="quarto-search-results"></div>
  <header id="quarto-header" class="headroom fixed-top">
    <nav class="navbar navbar-expand-lg navbar-dark ">
      <div class="navbar-container container-fluid">
      <div class="navbar-brand-container">
    <a class="navbar-brand" href="./index.html">
    <span class="navbar-title">ipw-selection</span>
    </a>
  </div>
          <button class="navbar-toggler" type="button" data-bs-toggle="collapse" data-bs-target="#navbarCollapse" aria-controls="navbarCollapse" aria-expanded="false" aria-label="Toggle navigation" onclick="if (window.quartoToggleHeadroom) { window.quartoToggleHeadroom(); }">
  <span class="navbar-toggler-icon"></span>
</button>
          <div class="collapse navbar-collapse" id="navbarCollapse">
            <ul class="navbar-nav navbar-nav-scroll me-auto">
  <li class="nav-item">
    <a class="nav-link active" href="./index.html" aria-current="page">
 <span class="menu-text">Home</span></a>
  </li>  
  <li class="nav-item">
    <a class="nav-link" href="https://www.google.es/">
 <span class="menu-text">Blog</span></a>
  </li>  
</ul>
              <div id="quarto-search" class="" title="Search"></div>
          </div> <!-- /navcollapse -->
      </div> <!-- /container-fluid -->
    </nav>
</header>
<!-- content -->
<div id="quarto-content" class="quarto-container page-columns page-rows-contents page-layout-article page-navbar">
<!-- sidebar -->
<!-- margin-sidebar -->
    <div id="quarto-margin-sidebar" class="sidebar margin-sidebar">
        <nav id="TOC" role="doc-toc" class="toc-active">
    <h2 id="toc-title">On this page</h2>
   
  <ul>
  <li><a href="#selection-bias-and-ipw-methods" id="toc-selection-bias-and-ipw-methods" class="nav-link active" data-scroll-target="#selection-bias-and-ipw-methods">Selection bias and IPW methods</a>
  <ul class="collapse">
  <li><a href="#question-selection-mediation-and-ipw-methods" id="toc-question-selection-mediation-and-ipw-methods" class="nav-link" data-scroll-target="#question-selection-mediation-and-ipw-methods">Question: selection, mediation and IPW methods</a>
  <ul class="collapse">
  <li><a href="#simple-simulation-setting" id="toc-simple-simulation-setting" class="nav-link" data-scroll-target="#simple-simulation-setting">Simple simulation setting</a></li>
  <li><a href="#the-dag" id="toc-the-dag" class="nav-link" data-scroll-target="#the-dag">The DAG:</a></li>
  <li><a href="#structural-equations" id="toc-structural-equations" class="nav-link" data-scroll-target="#structural-equations">Structural equations:</a></li>
  </ul></li>
  <li><a href="#case-1-selection-does-not-depend-on-a-mediator" id="toc-case-1-selection-does-not-depend-on-a-mediator" class="nav-link" data-scroll-target="#case-1-selection-does-not-depend-on-a-mediator">Case 1: Selection does not depend on a mediator</a>
  <ul class="collapse">
  <li><a href="#results-under-no-exclusion-complete-data" id="toc-results-under-no-exclusion-complete-data" class="nav-link" data-scroll-target="#results-under-no-exclusion-complete-data">Results under no exclusion (complete data)</a></li>
  <li><a href="#results-under-exclusion" id="toc-results-under-exclusion" class="nav-link" data-scroll-target="#results-under-exclusion">Results under exclusion</a></li>
  </ul></li>
  <li><a href="#case-2-selection-does-depend-on-a-mediator" id="toc-case-2-selection-does-depend-on-a-mediator" class="nav-link" data-scroll-target="#case-2-selection-does-depend-on-a-mediator">Case 2: Selection does depend on a mediator</a></li>
  </ul></li>
  </ul>
</nav>
    </div>
<!-- main -->
<main class="content" id="quarto-document-content">

<header id="title-block-header" class="quarto-title-block default">
<div class="quarto-title">
<h1 class="title">When selection depends on mediation: part 1</h1>
</div>



<div class="quarto-title-meta">

    <div>
    <div class="quarto-title-meta-heading">Author</div>
    <div class="quarto-title-meta-contents">
             <p>Johan de Aguas </p>
          </div>
  </div>
    
  
    
  </div>
  

</header>

<hr>
<section id="selection-bias-and-ipw-methods" class="level1">
<h1>Selection bias and IPW methods</h1>
<p><em>Confounding bias</em> and <em>selection bias</em> are together the most prevalent hurdles to the validity and generalizability of causal inference results. In general, both arise from uncontrolled extraneous flows of statistical information between treatment and outcome in the analysis. Their precise characterization in the Structural Causal Models framework (SCM), and potential corrections, differ in nature:</p>
<ul>
<li><p><strong>Confounding bias</strong> emerges from <em>open backdoor paths</em> between treatment and outcome in the directed acyclic graph (DAG) that represents the set of assumptions on the system’s causal mechanisms. In experimental settings, (conditional) randomization of treatment assignment provides a practical solution to the problem. In observational studies, the <em>do</em>-calculus, developed by Judea Pearl <span class="citation" data-cites="pearl2009">(<a href="#ref-pearl2009" role="doc-biblioref">Pearl 2009</a>)</span>, constitute a complete and formal set of graphical rules to test the identifiability of the target causal parameters.</p></li>
<li><p><strong>Selection bias</strong> emerges from the preferential exclusion of units from the sample under analysis. It implies conditioning on a <em>collider</em> (or a descendant of a <em>virtual collider</em>), which opens backdoor paths between treatment and outcome. Besides, distributions learnt from the biased samples might not generalize to the whole population. Selection bias cannot be removed via randomization, which makes it a concern for experimental settings as well. There exist extensions of the <em>do</em>-calculus to deal with selection bias in some cases. <em>Inverse probability weighting</em> (IPW) methods are more frequently used in applied work.</p></li>
</ul>
<section id="question-selection-mediation-and-ipw-methods" class="level2">
<h2 class="anchored" data-anchor-id="question-selection-mediation-and-ipw-methods">Question: selection, mediation and IPW methods</h2>
<p><em>Inverse probability weighting</em> (IPW) methods provide nonparametric statistical techniques to perform inference with biased data. In their basic presentation, they approximate the <em>interventional mean</em> of the outcome using a weighted average over the selected sample. Let:</p>
<ul>
<li><p><span class="math inline">\((y_i)_{i=1}^N\)</span> be a sample of outcomes for the selected (non-excluded) units</p></li>
<li><p><span class="math inline">\(w_i\)</span> be the relative inverse probability of selection, <span class="math inline">\(w_i=p/p_i\)</span>, where <span class="math inline">\(p\)</span> is the population-level probability of selection, and <span class="math inline">\(p_i\)</span> is the probability of selection for unit <span class="math inline">\(i\)</span></p></li>
<li><p><span class="math inline">\(v_i(a)\)</span> be the inverse probability of assignment of treatment <span class="math inline">\(a\)</span> for unit <span class="math inline">\(i\)</span>.</p></li>
</ul>
<p>The idea of IPW methods is motivated by the desired asymptotic result (*):</p>
<p><span class="math display">\[
\lim_{N\rightarrow\infty} N^{-1}\sum_{i=1}^N \mathbb{I}[A_i=a] v_i(a)\cdot w_i\cdot y_i\longrightarrow \mathbb{E}[Y\mid do(A=a)]
\]</span></p>
<p>The derived finite-sample estimator is consistent if <span class="math inline">\(v_i(a)\cdot w_i\)</span> is; this is, if the probability of selection and the probability of treatment assignment are jointly correctly specified.</p>
<p>The question that motivates the present analysis is:</p>
<blockquote class="blockquote">
<p><em>Is the IPW estimator still consistent if the probability of selection depends on a mediator of the causal effect?</em></p>
</blockquote>
<p>To answer this question let us analyse the results of an IPW-based approach on a simple simulation with a randomized treatment assignment under two cases:</p>
<ol type="1">
<li><p>The selection mechanism does not depend on a mediator</p></li>
<li><p>The selection mechanism does depend on a mediator</p></li>
</ol>
<section id="simple-simulation-setting" class="level3">
<h3 class="anchored" data-anchor-id="simple-simulation-setting">Simple simulation setting</h3>
<p>Let us consider the SCM given by the following DAG and set of structural equations:</p>
</section>
<section id="the-dag" class="level3">
<h3 class="anchored" data-anchor-id="the-dag">The DAG:</h3>
<div class="cell">
<details>
<summary>Code</summary>
<div class="sourceCode cell-code" id="cb1"><pre class="sourceCode r code-with-copy"><code class="sourceCode r"><span id="cb1-1"><a href="#cb1-1" aria-hidden="true" tabindex="-1"></a><span class="co"># DAG visualization</span></span>
<span id="cb1-2"><a href="#cb1-2" aria-hidden="true" tabindex="-1"></a><span class="fu">library</span>(ggplot2)</span>
<span id="cb1-3"><a href="#cb1-3" aria-hidden="true" tabindex="-1"></a><span class="fu">library</span>(dagitty)</span>
<span id="cb1-4"><a href="#cb1-4" aria-hidden="true" tabindex="-1"></a><span class="fu">library</span>(ggdag)</span>
<span id="cb1-5"><a href="#cb1-5" aria-hidden="true" tabindex="-1"></a></span>
<span id="cb1-6"><a href="#cb1-6" aria-hidden="true" tabindex="-1"></a><span class="fu">dagify</span>(</span>
<span id="cb1-7"><a href="#cb1-7" aria-hidden="true" tabindex="-1"></a>  M <span class="sc">~</span> A,</span>
<span id="cb1-8"><a href="#cb1-8" aria-hidden="true" tabindex="-1"></a>  S <span class="sc">~</span> A <span class="sc">+</span> M <span class="sc">+</span> L,</span>
<span id="cb1-9"><a href="#cb1-9" aria-hidden="true" tabindex="-1"></a>  Y <span class="sc">~</span> A <span class="sc">+</span> M <span class="sc">+</span> L</span>
<span id="cb1-10"><a href="#cb1-10" aria-hidden="true" tabindex="-1"></a>) <span class="sc">%&gt;%</span> <span class="fu">tidy_dagitty</span>(<span class="at">layout =</span> <span class="st">"nicely"</span>) <span class="sc">%&gt;%</span></span>
<span id="cb1-11"><a href="#cb1-11" aria-hidden="true" tabindex="-1"></a>  <span class="fu">ggplot</span>(<span class="fu">aes</span>(<span class="at">x =</span> x, <span class="at">y =</span> y, <span class="at">xend =</span> xend, <span class="at">yend =</span> yend)) <span class="sc">+</span></span>
<span id="cb1-12"><a href="#cb1-12" aria-hidden="true" tabindex="-1"></a>  <span class="fu">geom_dag_point</span>(<span class="at">color=</span><span class="st">'white'</span>,<span class="at">size=</span><span class="fl">0.5</span>) <span class="sc">+</span></span>
<span id="cb1-13"><a href="#cb1-13" aria-hidden="true" tabindex="-1"></a>  <span class="fu">geom_dag_edges</span>() <span class="sc">+</span></span>
<span id="cb1-14"><a href="#cb1-14" aria-hidden="true" tabindex="-1"></a>  <span class="fu">geom_dag_text</span>(<span class="at">color=</span><span class="st">'black'</span>) <span class="sc">+</span></span>
<span id="cb1-15"><a href="#cb1-15" aria-hidden="true" tabindex="-1"></a>  <span class="fu">theme_dag</span>()</span></code><button title="Copy to Clipboard" class="code-copy-button"><i class="bi"></i></button></pre></div>
</details>
<div class="cell-output-display">
<p><img src="index_files/figure-html/unnamed-chunk-1-1.png" class="img-fluid" width="480"></p>
</div>
</div>
</section>
<section id="structural-equations" class="level3">
<h3 class="anchored" data-anchor-id="structural-equations">Structural equations:</h3>
<p><span class="math display">\[
\begin{aligned}[c]
L &amp;\sim\text{Nor}(0,\sigma^2_L) &amp; &amp;\\
A &amp;\sim\text{Ber}(q) &amp; &amp;\\
M &amp;= \alpha_0 + \alpha_1A + u_M &amp; u_M &amp;\sim\text{Nor}(0,\sigma^2_M) \\
S &amp;= \mathbb{I}[\gamma_0 + \gamma_1A + \gamma_2M + \gamma_3L + u_S &gt; 0] &amp; u_S &amp;\sim\text{Nor}(0,\sigma^2_S) \\
Y &amp;= \beta_0 + \beta_1A + \beta_2M + \beta_3L + u_Y &amp; u_Y &amp;\sim\text{Nor}(0,\sigma^2_Y)
\end{aligned}
\]</span></p>
<p>Let us put this SCM as a data-generating process (DGP) in <em>R</em> code:</p>
<div class="cell">
<details>
<summary>Code</summary>
<div class="sourceCode cell-code" id="cb2"><pre class="sourceCode r code-with-copy"><code class="sourceCode r"><span id="cb2-1"><a href="#cb2-1" aria-hidden="true" tabindex="-1"></a><span class="co"># Libraries needed</span></span>
<span id="cb2-2"><a href="#cb2-2" aria-hidden="true" tabindex="-1"></a><span class="fu">library</span>(DescTools)</span>
<span id="cb2-3"><a href="#cb2-3" aria-hidden="true" tabindex="-1"></a><span class="fu">library</span>(LaplacesDemon)</span>
<span id="cb2-4"><a href="#cb2-4" aria-hidden="true" tabindex="-1"></a><span class="fu">library</span>(dplyr)</span>
<span id="cb2-5"><a href="#cb2-5" aria-hidden="true" tabindex="-1"></a><span class="fu">library</span>(kableExtra)</span>
<span id="cb2-6"><a href="#cb2-6" aria-hidden="true" tabindex="-1"></a><span class="fu">library</span>(modelsummary)</span>
<span id="cb2-7"><a href="#cb2-7" aria-hidden="true" tabindex="-1"></a><span class="fu">library</span>(gt)</span>
<span id="cb2-8"><a href="#cb2-8" aria-hidden="true" tabindex="-1"></a><span class="fu">library</span>(zeallot)</span>
<span id="cb2-9"><a href="#cb2-9" aria-hidden="true" tabindex="-1"></a><span class="fu">library</span>(reshape2)</span>
<span id="cb2-10"><a href="#cb2-10" aria-hidden="true" tabindex="-1"></a></span>
<span id="cb2-11"><a href="#cb2-11" aria-hidden="true" tabindex="-1"></a><span class="co"># Data generating process</span></span>
<span id="cb2-12"><a href="#cb2-12" aria-hidden="true" tabindex="-1"></a>dgp <span class="ot">=</span> <span class="cf">function</span>(param){</span>
<span id="cb2-13"><a href="#cb2-13" aria-hidden="true" tabindex="-1"></a>  </span>
<span id="cb2-14"><a href="#cb2-14" aria-hidden="true" tabindex="-1"></a>  <span class="do">#### Parameters</span></span>
<span id="cb2-15"><a href="#cb2-15" aria-hidden="true" tabindex="-1"></a>  <span class="fu">c</span>(n,      <span class="co"># Number of samples</span></span>
<span id="cb2-16"><a href="#cb2-16" aria-hidden="true" tabindex="-1"></a>    sdl,    <span class="co"># Stdr. dev. of selection predictor</span></span>
<span id="cb2-17"><a href="#cb2-17" aria-hidden="true" tabindex="-1"></a>    p,      <span class="co"># Treatment assigment probability</span></span>
<span id="cb2-18"><a href="#cb2-18" aria-hidden="true" tabindex="-1"></a>    a0, a1, <span class="co"># Parameters of A-&gt;M relation</span></span>
<span id="cb2-19"><a href="#cb2-19" aria-hidden="true" tabindex="-1"></a>    sdm,    <span class="co"># Stdr. dev. of mediator noise</span></span>
<span id="cb2-20"><a href="#cb2-20" aria-hidden="true" tabindex="-1"></a>    g0, g1, <span class="co"># Parameters of A-&gt;S relation</span></span>
<span id="cb2-21"><a href="#cb2-21" aria-hidden="true" tabindex="-1"></a>    g2,     <span class="co"># Parameter of M-&gt;S relation</span></span>
<span id="cb2-22"><a href="#cb2-22" aria-hidden="true" tabindex="-1"></a>    g3,     <span class="co"># Parameter of L-&gt;S relation</span></span>
<span id="cb2-23"><a href="#cb2-23" aria-hidden="true" tabindex="-1"></a>    sds,    <span class="co"># Stdr. dev. of selection noise</span></span>
<span id="cb2-24"><a href="#cb2-24" aria-hidden="true" tabindex="-1"></a>    b0, b1, <span class="co"># Parameters of A-&gt;Y relation</span></span>
<span id="cb2-25"><a href="#cb2-25" aria-hidden="true" tabindex="-1"></a>    b2,     <span class="co"># Parameter of M-&gt;Y relation</span></span>
<span id="cb2-26"><a href="#cb2-26" aria-hidden="true" tabindex="-1"></a>    b3,     <span class="co"># Parameter of L-&gt;Y relation</span></span>
<span id="cb2-27"><a href="#cb2-27" aria-hidden="true" tabindex="-1"></a>    sdy <span class="co"># Stdr. dev. of selection noise</span></span>
<span id="cb2-28"><a href="#cb2-28" aria-hidden="true" tabindex="-1"></a>    ) <span class="sc">%&lt;-%</span> param     </span>
<span id="cb2-29"><a href="#cb2-29" aria-hidden="true" tabindex="-1"></a>  </span>
<span id="cb2-30"><a href="#cb2-30" aria-hidden="true" tabindex="-1"></a>  <span class="co"># Exogenous selection predictor</span></span>
<span id="cb2-31"><a href="#cb2-31" aria-hidden="true" tabindex="-1"></a>  L <span class="ot">=</span> <span class="fu">rnorm</span>(<span class="at">n=</span>n, <span class="at">mean=</span><span class="dv">0</span>, <span class="at">sd=</span>sdl)</span>
<span id="cb2-32"><a href="#cb2-32" aria-hidden="true" tabindex="-1"></a>  </span>
<span id="cb2-33"><a href="#cb2-33" aria-hidden="true" tabindex="-1"></a>  <span class="co"># Treatment assigment</span></span>
<span id="cb2-34"><a href="#cb2-34" aria-hidden="true" tabindex="-1"></a>  A <span class="ot">=</span> <span class="fu">rbinom</span>(<span class="at">n=</span>n, <span class="at">size=</span><span class="dv">1</span>, <span class="at">prob=</span>p)</span>
<span id="cb2-35"><a href="#cb2-35" aria-hidden="true" tabindex="-1"></a>  </span>
<span id="cb2-36"><a href="#cb2-36" aria-hidden="true" tabindex="-1"></a>  <span class="co"># Mediator</span></span>
<span id="cb2-37"><a href="#cb2-37" aria-hidden="true" tabindex="-1"></a>  noise.M <span class="ot">=</span> <span class="fu">rnorm</span>(<span class="at">n=</span>n, <span class="at">mean=</span><span class="dv">0</span>, <span class="at">sd=</span>sdm)</span>
<span id="cb2-38"><a href="#cb2-38" aria-hidden="true" tabindex="-1"></a>  M <span class="ot">=</span> a0 <span class="sc">+</span> a1<span class="sc">*</span>A <span class="sc">+</span> noise.M</span>
<span id="cb2-39"><a href="#cb2-39" aria-hidden="true" tabindex="-1"></a>  </span>
<span id="cb2-40"><a href="#cb2-40" aria-hidden="true" tabindex="-1"></a>  <span class="co"># Selection mechanism</span></span>
<span id="cb2-41"><a href="#cb2-41" aria-hidden="true" tabindex="-1"></a>  noise.S <span class="ot">=</span> <span class="fu">rnorm</span>(<span class="at">n=</span>n, <span class="at">mean=</span><span class="dv">0</span>, <span class="at">sd=</span>sds)</span>
<span id="cb2-42"><a href="#cb2-42" aria-hidden="true" tabindex="-1"></a>  S <span class="ot">=</span> <span class="fu">ifelse</span>(g0 <span class="sc">+</span> g1<span class="sc">*</span>A <span class="sc">+</span> g2<span class="sc">*</span>M <span class="sc">+</span> g3<span class="sc">*</span>L <span class="sc">+</span> noise.S <span class="sc">&gt;</span> <span class="dv">0</span>, <span class="dv">1</span>, <span class="dv">0</span>)</span>
<span id="cb2-43"><a href="#cb2-43" aria-hidden="true" tabindex="-1"></a>  </span>
<span id="cb2-44"><a href="#cb2-44" aria-hidden="true" tabindex="-1"></a>  <span class="co"># Outcome</span></span>
<span id="cb2-45"><a href="#cb2-45" aria-hidden="true" tabindex="-1"></a>  noise.Y <span class="ot">=</span> <span class="fu">rnorm</span>(<span class="at">n=</span>n, <span class="at">mean=</span><span class="dv">0</span>, <span class="at">sd=</span>sdy)</span>
<span id="cb2-46"><a href="#cb2-46" aria-hidden="true" tabindex="-1"></a>  Y <span class="ot">=</span> b0 <span class="sc">+</span> b1<span class="sc">*</span>A <span class="sc">+</span> b2<span class="sc">*</span>M <span class="sc">+</span> b3<span class="sc">*</span>L <span class="sc">+</span> noise.Y</span>
<span id="cb2-47"><a href="#cb2-47" aria-hidden="true" tabindex="-1"></a>  </span>
<span id="cb2-48"><a href="#cb2-48" aria-hidden="true" tabindex="-1"></a>  <span class="co"># true ATE</span></span>
<span id="cb2-49"><a href="#cb2-49" aria-hidden="true" tabindex="-1"></a>  true.ATE <span class="ot">=</span> b1 <span class="sc">+</span> b2<span class="sc">*</span>a1</span>
<span id="cb2-50"><a href="#cb2-50" aria-hidden="true" tabindex="-1"></a>  </span>
<span id="cb2-51"><a href="#cb2-51" aria-hidden="true" tabindex="-1"></a>  <span class="co"># Data</span></span>
<span id="cb2-52"><a href="#cb2-52" aria-hidden="true" tabindex="-1"></a>  dat <span class="ot">=</span> <span class="fu">data.frame</span>(L,A,M,S,Y)</span>
<span id="cb2-53"><a href="#cb2-53" aria-hidden="true" tabindex="-1"></a>  </span>
<span id="cb2-54"><a href="#cb2-54" aria-hidden="true" tabindex="-1"></a>  <span class="co"># Return</span></span>
<span id="cb2-55"><a href="#cb2-55" aria-hidden="true" tabindex="-1"></a>  <span class="fu">return</span>(<span class="fu">list</span>(dat,true.ATE))</span>
<span id="cb2-56"><a href="#cb2-56" aria-hidden="true" tabindex="-1"></a>}</span></code><button title="Copy to Clipboard" class="code-copy-button"><i class="bi"></i></button></pre></div>
</details>
</div>
<hr>
</section>
</section>
<section id="case-1-selection-does-not-depend-on-a-mediator" class="level2">
<h2 class="anchored" data-anchor-id="case-1-selection-does-not-depend-on-a-mediator">Case 1: Selection does not depend on a mediator</h2>
<p>This case is equivalent to setting <span class="math inline">\(\gamma_2=0\)</span> in the structural equation of the selection mechanism <span class="math inline">\(S\)</span>. Let us simulate some noisy data:</p>
<div class="cell">
<details>
<summary>Code</summary>
<div class="sourceCode cell-code" id="cb3"><pre class="sourceCode r code-with-copy"><code class="sourceCode r"><span id="cb3-1"><a href="#cb3-1" aria-hidden="true" tabindex="-1"></a><span class="co"># Set random seed</span></span>
<span id="cb3-2"><a href="#cb3-2" aria-hidden="true" tabindex="-1"></a><span class="fu">set.seed</span>(<span class="dv">7</span>)</span>
<span id="cb3-3"><a href="#cb3-3" aria-hidden="true" tabindex="-1"></a></span>
<span id="cb3-4"><a href="#cb3-4" aria-hidden="true" tabindex="-1"></a><span class="co"># Parameters values</span></span>
<span id="cb3-5"><a href="#cb3-5" aria-hidden="true" tabindex="-1"></a>param<span class="fl">.1</span> <span class="ot">=</span> <span class="fu">c</span>(</span>
<span id="cb3-6"><a href="#cb3-6" aria-hidden="true" tabindex="-1"></a>  <span class="at">n=</span><span class="fl">1e3</span>,             <span class="co"># Number of samples</span></span>
<span id="cb3-7"><a href="#cb3-7" aria-hidden="true" tabindex="-1"></a>  <span class="at">sdl=</span><span class="dv">1</span>,             <span class="co"># Stdr. dev. of selection predictor</span></span>
<span id="cb3-8"><a href="#cb3-8" aria-hidden="true" tabindex="-1"></a>  <span class="at">p=</span><span class="fl">0.5</span>,             <span class="co"># Treatment assigment probability</span></span>
<span id="cb3-9"><a href="#cb3-9" aria-hidden="true" tabindex="-1"></a>  <span class="at">a0=</span><span class="fl">0.1</span>, <span class="at">a1=</span><span class="fl">0.5</span>,    <span class="co"># Parameters of A-&gt;M relation</span></span>
<span id="cb3-10"><a href="#cb3-10" aria-hidden="true" tabindex="-1"></a>  <span class="at">sdm=</span><span class="fl">0.4</span>,           <span class="co"># Stdr. dev. of mediator noise</span></span>
<span id="cb3-11"><a href="#cb3-11" aria-hidden="true" tabindex="-1"></a>  <span class="at">g0=</span><span class="sc">-</span><span class="fl">0.1</span>, <span class="at">g1=</span><span class="fl">0.2</span>,   <span class="co"># Parameters of A-&gt;S relation</span></span>
<span id="cb3-12"><a href="#cb3-12" aria-hidden="true" tabindex="-1"></a>  <span class="at">g2=</span><span class="dv">0</span>,              <span class="co"># Parameter of M-&gt;S relation </span><span class="al">###</span><span class="co"> M DOES NOT CAUSE S</span></span>
<span id="cb3-13"><a href="#cb3-13" aria-hidden="true" tabindex="-1"></a>  <span class="at">g3=</span><span class="fl">0.2</span>,            <span class="co"># Parameter of L-&gt;S relation</span></span>
<span id="cb3-14"><a href="#cb3-14" aria-hidden="true" tabindex="-1"></a>  <span class="at">sds=</span><span class="fl">0.5</span>,           <span class="co"># Stdr. dev. of selection noise</span></span>
<span id="cb3-15"><a href="#cb3-15" aria-hidden="true" tabindex="-1"></a>  <span class="at">b0=</span><span class="sc">-</span><span class="fl">1.5</span>, <span class="at">b1=</span><span class="fl">0.5</span>,   <span class="co"># Parameters of A-&gt;Y relation</span></span>
<span id="cb3-16"><a href="#cb3-16" aria-hidden="true" tabindex="-1"></a>  <span class="at">b2=</span><span class="fl">0.5</span>,            <span class="co"># Parameter of M-&gt;Y relation</span></span>
<span id="cb3-17"><a href="#cb3-17" aria-hidden="true" tabindex="-1"></a>  <span class="at">b3=</span><span class="fl">1.8</span>,            <span class="co"># Parameter of L-&gt;Y relation</span></span>
<span id="cb3-18"><a href="#cb3-18" aria-hidden="true" tabindex="-1"></a>  <span class="at">sdy=</span><span class="fl">2.7</span>)           <span class="co"># Stdr. dev. of selection noise</span></span>
<span id="cb3-19"><a href="#cb3-19" aria-hidden="true" tabindex="-1"></a></span>
<span id="cb3-20"><a href="#cb3-20" aria-hidden="true" tabindex="-1"></a><span class="co"># Generate data</span></span>
<span id="cb3-21"><a href="#cb3-21" aria-hidden="true" tabindex="-1"></a>dgp<span class="fl">.1</span> <span class="ot">=</span> <span class="fu">dgp</span>(param<span class="fl">.1</span>)</span>
<span id="cb3-22"><a href="#cb3-22" aria-hidden="true" tabindex="-1"></a></span>
<span id="cb3-23"><a href="#cb3-23" aria-hidden="true" tabindex="-1"></a><span class="co"># Save the full data</span></span>
<span id="cb3-24"><a href="#cb3-24" aria-hidden="true" tabindex="-1"></a>dat<span class="fl">.1</span> <span class="ot">=</span> dgp<span class="fl">.1</span>[[<span class="dv">1</span>]]</span>
<span id="cb3-25"><a href="#cb3-25" aria-hidden="true" tabindex="-1"></a></span>
<span id="cb3-26"><a href="#cb3-26" aria-hidden="true" tabindex="-1"></a><span class="co"># Save the true ATE</span></span>
<span id="cb3-27"><a href="#cb3-27" aria-hidden="true" tabindex="-1"></a>T.ATE <span class="ot">=</span> dgp<span class="fl">.1</span>[[<span class="dv">2</span>]]</span>
<span id="cb3-28"><a href="#cb3-28" aria-hidden="true" tabindex="-1"></a></span>
<span id="cb3-29"><a href="#cb3-29" aria-hidden="true" tabindex="-1"></a><span class="co"># Glimpse of the data</span></span>
<span id="cb3-30"><a href="#cb3-30" aria-hidden="true" tabindex="-1"></a><span class="fu">head</span>(dat<span class="fl">.1</span>) <span class="sc">%&gt;%</span> <span class="fu">kbl</span>() <span class="sc">%&gt;%</span> <span class="fu">kable_styling</span>(<span class="at">full_width =</span> F)</span></code><button title="Copy to Clipboard" class="code-copy-button"><i class="bi"></i></button></pre></div>
</details>
<div class="cell-output-display">

<table class="table" style="width: auto !important; margin-left: auto; margin-right: auto;">
 <thead>
  <tr>
   <th style="text-align:right;"> L </th>
   <th style="text-align:right;"> A </th>
   <th style="text-align:right;"> M </th>
   <th style="text-align:right;"> S </th>
   <th style="text-align:right;"> Y </th>
  </tr>
 </thead>
<tbody>
  <tr>
   <td style="text-align:right;"> 2.2872472 </td>
   <td style="text-align:right;"> 1 </td>
   <td style="text-align:right;"> 0.2988695 </td>
   <td style="text-align:right;"> 1 </td>
   <td style="text-align:right;"> -0.0302749 </td>
  </tr>
  <tr>
   <td style="text-align:right;"> -1.1967717 </td>
   <td style="text-align:right;"> 1 </td>
   <td style="text-align:right;"> 0.5175524 </td>
   <td style="text-align:right;"> 0 </td>
   <td style="text-align:right;"> 3.7544911 </td>
  </tr>
  <tr>
   <td style="text-align:right;"> -0.6942925 </td>
   <td style="text-align:right;"> 0 </td>
   <td style="text-align:right;"> 0.0183553 </td>
   <td style="text-align:right;"> 0 </td>
   <td style="text-align:right;"> -3.2428682 </td>
  </tr>
  <tr>
   <td style="text-align:right;"> -0.4122930 </td>
   <td style="text-align:right;"> 1 </td>
   <td style="text-align:right;"> 0.3229087 </td>
   <td style="text-align:right;"> 1 </td>
   <td style="text-align:right;"> 2.8405141 </td>
  </tr>
  <tr>
   <td style="text-align:right;"> -0.9706733 </td>
   <td style="text-align:right;"> 1 </td>
   <td style="text-align:right;"> 0.7833466 </td>
   <td style="text-align:right;"> 0 </td>
   <td style="text-align:right;"> -4.9430929 </td>
  </tr>
  <tr>
   <td style="text-align:right;"> -0.9472799 </td>
   <td style="text-align:right;"> 1 </td>
   <td style="text-align:right;"> -0.6778373 </td>
   <td style="text-align:right;"> 0 </td>
   <td style="text-align:right;"> -5.7906748 </td>
  </tr>
</tbody>
</table>

</div>
</div>
<p>We can compute the true ATE underlying this SCM:</p>
<div class="cell">
<details>
<summary>Code</summary>
<div class="sourceCode cell-code" id="cb4"><pre class="sourceCode r code-with-copy"><code class="sourceCode r"><span id="cb4-1"><a href="#cb4-1" aria-hidden="true" tabindex="-1"></a><span class="co"># True ATE</span></span>
<span id="cb4-2"><a href="#cb4-2" aria-hidden="true" tabindex="-1"></a><span class="fu">data.frame</span>(<span class="st">'True ATE'</span><span class="ot">=</span>T.ATE) <span class="sc">%&gt;%</span> <span class="fu">kbl</span>() <span class="sc">%&gt;%</span> <span class="fu">kable_styling</span>(<span class="at">full_width =</span> F)</span></code><button title="Copy to Clipboard" class="code-copy-button"><i class="bi"></i></button></pre></div>
</details>
<div class="cell-output-display">

<table class="table" style="width: auto !important; margin-left: auto; margin-right: auto;">
 <thead>
  <tr>
   <th style="text-align:right;"> True.ATE </th>
  </tr>
 </thead>
<tbody>
  <tr>
   <td style="text-align:right;"> 0.75 </td>
  </tr>
</tbody>
</table>

</div>
</div>
<hr>
<section id="results-under-no-exclusion-complete-data" class="level3">
<h3 class="anchored" data-anchor-id="results-under-no-exclusion-complete-data">Results under no exclusion (complete data)</h3>
<p>For a moment let us pretend we observe all variables for everyone. Let us examine the most interesting models that we can fit with the simulated data, to check their ability to recover population-level parameters under noisy samples.</p>
<div class="cell">
<details>
<summary>Code</summary>
<div class="sourceCode cell-code" id="cb5"><pre class="sourceCode r code-with-copy"><code class="sourceCode r"><span id="cb5-1"><a href="#cb5-1" aria-hidden="true" tabindex="-1"></a><span class="co"># Model for M, with complete data</span></span>
<span id="cb5-2"><a href="#cb5-2" aria-hidden="true" tabindex="-1"></a>mod.M <span class="ot">=</span> <span class="fu">lm</span>(M <span class="sc">~</span> A, <span class="at">data=</span>dat<span class="fl">.1</span>)</span>
<span id="cb5-3"><a href="#cb5-3" aria-hidden="true" tabindex="-1"></a></span>
<span id="cb5-4"><a href="#cb5-4" aria-hidden="true" tabindex="-1"></a><span class="co"># Model for S, with complete data</span></span>
<span id="cb5-5"><a href="#cb5-5" aria-hidden="true" tabindex="-1"></a>mod.S <span class="ot">=</span> <span class="fu">glm</span>(S <span class="sc">~</span> A <span class="sc">+</span> L, <span class="at">family=</span><span class="fu">binomial</span>(<span class="st">'probit'</span>), <span class="at">data=</span>dat<span class="fl">.1</span>)</span>
<span id="cb5-6"><a href="#cb5-6" aria-hidden="true" tabindex="-1"></a></span>
<span id="cb5-7"><a href="#cb5-7" aria-hidden="true" tabindex="-1"></a><span class="co"># Model for Y, with complete data</span></span>
<span id="cb5-8"><a href="#cb5-8" aria-hidden="true" tabindex="-1"></a>mod.Y <span class="ot">=</span> <span class="fu">lm</span>(Y <span class="sc">~</span> A <span class="sc">+</span> M <span class="sc">+</span> L, <span class="at">data=</span>dat<span class="fl">.1</span>)</span>
<span id="cb5-9"><a href="#cb5-9" aria-hidden="true" tabindex="-1"></a></span>
<span id="cb5-10"><a href="#cb5-10" aria-hidden="true" tabindex="-1"></a><span class="co"># Model for causal effect, with complete data</span></span>
<span id="cb5-11"><a href="#cb5-11" aria-hidden="true" tabindex="-1"></a><span class="co"># Version 1: Controlling for predictor of Y</span></span>
<span id="cb5-12"><a href="#cb5-12" aria-hidden="true" tabindex="-1"></a>mod.ate<span class="fl">.1</span> <span class="ot">=</span> <span class="fu">lm</span>(Y <span class="sc">~</span> A <span class="sc">+</span> L, <span class="at">data=</span>dat<span class="fl">.1</span>)</span>
<span id="cb5-13"><a href="#cb5-13" aria-hidden="true" tabindex="-1"></a></span>
<span id="cb5-14"><a href="#cb5-14" aria-hidden="true" tabindex="-1"></a><span class="co"># Model for causal effect, with complete data</span></span>
<span id="cb5-15"><a href="#cb5-15" aria-hidden="true" tabindex="-1"></a><span class="co"># Version 2: Treatment is randomized, no controls needed</span></span>
<span id="cb5-16"><a href="#cb5-16" aria-hidden="true" tabindex="-1"></a>mod.ate<span class="fl">.2</span> <span class="ot">=</span> <span class="fu">lm</span>(Y <span class="sc">~</span> A, <span class="at">data=</span>dat<span class="fl">.1</span>)</span>
<span id="cb5-17"><a href="#cb5-17" aria-hidden="true" tabindex="-1"></a></span>
<span id="cb5-18"><a href="#cb5-18" aria-hidden="true" tabindex="-1"></a><span class="co"># All models put together</span></span>
<span id="cb5-19"><a href="#cb5-19" aria-hidden="true" tabindex="-1"></a>models.full <span class="ot">=</span> <span class="fu">list</span>(<span class="st">"M"</span> <span class="ot">=</span> mod.M, <span class="st">"S"</span> <span class="ot">=</span> mod.S, <span class="st">"Y"</span> <span class="ot">=</span> mod.Y, <span class="st">"ATE (O-set)"</span> <span class="ot">=</span> mod.ate<span class="fl">.1</span>, <span class="st">"ATE (no adj)"</span> <span class="ot">=</span> mod.ate<span class="fl">.2</span>)</span>
<span id="cb5-20"><a href="#cb5-20" aria-hidden="true" tabindex="-1"></a></span>
<span id="cb5-21"><a href="#cb5-21" aria-hidden="true" tabindex="-1"></a><span class="co"># Summary of models</span></span>
<span id="cb5-22"><a href="#cb5-22" aria-hidden="true" tabindex="-1"></a><span class="fu">modelsummary</span>(models.full, <span class="at">statistic =</span> <span class="st">"[{conf.low}, {conf.high}]"</span>,</span>
<span id="cb5-23"><a href="#cb5-23" aria-hidden="true" tabindex="-1"></a>             <span class="at">estimate  =</span> <span class="st">"{estimate}{stars}"</span>) </span></code><button title="Copy to Clipboard" class="code-copy-button"><i class="bi"></i></button></pre></div>
</details>
<div class="cell-output-display">

<table class="table" style="width: auto !important; margin-left: auto; margin-right: auto;">
 <thead>
  <tr>
   <th style="text-align:left;">   </th>
   <th style="text-align:center;"> M </th>
   <th style="text-align:center;"> S </th>
   <th style="text-align:center;"> Y </th>
   <th style="text-align:center;"> ATE (O-set) </th>
   <th style="text-align:center;"> ATE (no adj) </th>
  </tr>
 </thead>
<tbody>
  <tr>
   <td style="text-align:left;"> (Intercept) </td>
   <td style="text-align:center;"> 0.104*** </td>
   <td style="text-align:center;"> −0.107+ </td>
   <td style="text-align:center;"> −1.579*** </td>
   <td style="text-align:center;"> −1.498*** </td>
   <td style="text-align:center;"> −1.524*** </td>
  </tr>
  <tr>
   <td style="text-align:left;">  </td>
   <td style="text-align:center;"> [0.069, 0.139] </td>
   <td style="text-align:center;"> [−0.219, 0.005] </td>
   <td style="text-align:center;"> [−1.816, −1.342] </td>
   <td style="text-align:center;"> [−1.732, −1.263] </td>
   <td style="text-align:center;"> [−1.803, −1.245] </td>
  </tr>
  <tr>
   <td style="text-align:left;"> A </td>
   <td style="text-align:center;"> 0.506*** </td>
   <td style="text-align:center;"> 0.296*** </td>
   <td style="text-align:center;"> 0.281 </td>
   <td style="text-align:center;"> 0.677*** </td>
   <td style="text-align:center;"> 0.742*** </td>
  </tr>
  <tr>
   <td style="text-align:left;">  </td>
   <td style="text-align:center;"> [0.456, 0.556] </td>
   <td style="text-align:center;"> [0.135, 0.457] </td>
   <td style="text-align:center;"> [−0.114, 0.675] </td>
   <td style="text-align:center;"> [0.340, 1.013] </td>
   <td style="text-align:center;"> [0.342, 1.141] </td>
  </tr>
  <tr>
   <td style="text-align:left;"> L </td>
   <td style="text-align:center;">  </td>
   <td style="text-align:center;"> 0.427*** </td>
   <td style="text-align:center;"> 1.755*** </td>
   <td style="text-align:center;"> 1.768*** </td>
   <td style="text-align:center;">  </td>
  </tr>
  <tr>
   <td style="text-align:left;">  </td>
   <td style="text-align:center;">  </td>
   <td style="text-align:center;"> [0.341, 0.514] </td>
   <td style="text-align:center;"> [1.584, 1.925] </td>
   <td style="text-align:center;"> [1.597, 1.940] </td>
   <td style="text-align:center;">  </td>
  </tr>
  <tr>
   <td style="text-align:left;"> M </td>
   <td style="text-align:center;">  </td>
   <td style="text-align:center;">  </td>
   <td style="text-align:center;"> 0.784*** </td>
   <td style="text-align:center;">  </td>
   <td style="text-align:center;">  </td>
  </tr>
  <tr>
   <td style="text-align:left;box-shadow: 0px 1px">  </td>
   <td style="text-align:center;box-shadow: 0px 1px">  </td>
   <td style="text-align:center;box-shadow: 0px 1px">  </td>
   <td style="text-align:center;box-shadow: 0px 1px"> [0.369, 1.200] </td>
   <td style="text-align:center;box-shadow: 0px 1px">  </td>
   <td style="text-align:center;box-shadow: 0px 1px">  </td>
  </tr>
  <tr>
   <td style="text-align:left;"> Num.Obs. </td>
   <td style="text-align:center;"> 1000 </td>
   <td style="text-align:center;"> 1000 </td>
   <td style="text-align:center;"> 1000 </td>
   <td style="text-align:center;"> 1000 </td>
   <td style="text-align:center;"> 1000 </td>
  </tr>
  <tr>
   <td style="text-align:left;"> R2 </td>
   <td style="text-align:center;"> 0.283 </td>
   <td style="text-align:center;">  </td>
   <td style="text-align:center;"> 0.311 </td>
   <td style="text-align:center;"> 0.301 </td>
   <td style="text-align:center;"> 0.013 </td>
  </tr>
  <tr>
   <td style="text-align:left;"> R2 Adj. </td>
   <td style="text-align:center;"> 0.282 </td>
   <td style="text-align:center;">  </td>
   <td style="text-align:center;"> 0.308 </td>
   <td style="text-align:center;"> 0.300 </td>
   <td style="text-align:center;"> 0.012 </td>
  </tr>
  <tr>
   <td style="text-align:left;"> AIC </td>
   <td style="text-align:center;"> 1022.7 </td>
   <td style="text-align:center;"> 1278.2 </td>
   <td style="text-align:center;"> 4824.1 </td>
   <td style="text-align:center;"> 4835.8 </td>
   <td style="text-align:center;"> 5178.8 </td>
  </tr>
  <tr>
   <td style="text-align:left;"> BIC </td>
   <td style="text-align:center;"> 1037.5 </td>
   <td style="text-align:center;"> 1292.9 </td>
   <td style="text-align:center;"> 4848.7 </td>
   <td style="text-align:center;"> 4855.5 </td>
   <td style="text-align:center;"> 5193.5 </td>
  </tr>
  <tr>
   <td style="text-align:left;"> Log.Lik. </td>
   <td style="text-align:center;"> −508.364 </td>
   <td style="text-align:center;"> −636.108 </td>
   <td style="text-align:center;"> −2407.072 </td>
   <td style="text-align:center;"> −2413.913 </td>
   <td style="text-align:center;"> −2586.403 </td>
  </tr>
  <tr>
   <td style="text-align:left;"> RMSE </td>
   <td style="text-align:center;"> 0.40 </td>
   <td style="text-align:center;"> 0.47 </td>
   <td style="text-align:center;"> 2.69 </td>
   <td style="text-align:center;"> 2.70 </td>
   <td style="text-align:center;"> 3.21 </td>
  </tr>
</tbody>
</table>

</div>
</div>
<p>Since the treatment is randomized, no <em>control</em> variables are required in the regression of <span class="math inline">\(Y\)</span> against <span class="math inline">\(A\)</span> to remove confounding bias. However, <span class="math inline">\(L\)</span> is in the <span class="math inline">\(O\)</span>-set of the effect; this is, controlling for <span class="math inline">\(L\)</span> produces an asymptotically more efficient estimator. Such property is not seen in finite samples [see last two models].</p>
<p>It is no surprise that, with complete data, the point-estimate for the coefficient of <span class="math inline">\(A\)</span> in the last two models lie close to the true ATE (0.75), even under a moderately noisy DGP (<span class="math inline">\(R^2\approx 0.3\)</span>).</p>
<hr>
</section>
<section id="results-under-exclusion" class="level3">
<h3 class="anchored" data-anchor-id="results-under-exclusion">Results under exclusion</h3>
<div class="cell">

</div>
<p>Ignoring samples for which <span class="math inline">\(S=0\)</span> reduces sample size from 1000 to 514. This is, the probability of exclusion is about 0.486.</p>
<div class="cell">
<details>
<summary>Code</summary>
<div class="sourceCode cell-code" id="cb6"><pre class="sourceCode r code-with-copy"><code class="sourceCode r"><span id="cb6-1"><a href="#cb6-1" aria-hidden="true" tabindex="-1"></a><span class="co"># Number of observation per selection</span></span>
<span id="cb6-2"><a href="#cb6-2" aria-hidden="true" tabindex="-1"></a><span class="co"># 1 = selected / observed</span></span>
<span id="cb6-3"><a href="#cb6-3" aria-hidden="true" tabindex="-1"></a><span class="co"># 0 = excluded</span></span>
<span id="cb6-4"><a href="#cb6-4" aria-hidden="true" tabindex="-1"></a><span class="fu">table</span>(dat<span class="fl">.1</span><span class="sc">$</span>S) <span class="sc">%&gt;%</span> <span class="fu">kbl</span>(<span class="at">col.names =</span> <span class="fu">c</span>(<span class="st">'S'</span>,<span class="st">'N'</span>)) <span class="sc">%&gt;%</span> <span class="fu">kable_styling</span>(<span class="at">full_width =</span> F)</span></code><button title="Copy to Clipboard" class="code-copy-button"><i class="bi"></i></button></pre></div>
</details>
<div class="cell-output-display">

<table class="table" style="width: auto !important; margin-left: auto; margin-right: auto;">
 <thead>
  <tr>
   <th style="text-align:left;"> S </th>
   <th style="text-align:right;"> N </th>
  </tr>
 </thead>
<tbody>
  <tr>
   <td style="text-align:left;"> 0 </td>
   <td style="text-align:right;"> 486 </td>
  </tr>
  <tr>
   <td style="text-align:left;"> 1 </td>
   <td style="text-align:right;"> 514 </td>
  </tr>
</tbody>
</table>

</div>
</div>
<p>In contrast with the complete data case, a regression-based approach for estimating the ATE with only the selected samples <strong>does</strong> require controlling for <span class="math inline">\(L\)</span>, since conditioning on <span class="math inline">\(S\)</span> opens two intertwined non-causal paths:</p>
<ul>
<li><p><span class="math inline">\(A\longrightarrow S\longleftarrow L\longrightarrow Y\)</span>. Here <span class="math inline">\(S\)</span> acts as a <em>real collider</em>.</p></li>
<li><p><span class="math inline">\(A\longleftrightarrow u_s\longleftrightarrow L\longrightarrow Y\)</span> . Here <span class="math inline">\(S\)</span> acts as a <em>virtual</em> collider.</p></li>
</ul>
<p>Unfortunately, controlling for <span class="math inline">\(L\)</span> alone <strong>does not</strong> remove selection bias, despite blocking such paths. This is because the distribution of <span class="math inline">\(L\)</span> in the sample does not necessarily match the distribution in the population.</p>
<p>Let us inspect it.</p>
<section id="regression-based-approach" class="level4">
<h4 class="anchored" data-anchor-id="regression-based-approach">Regression-based approach:</h4>
<p>We fit a model for the outcome <span class="math inline">\(Y\)</span> against <span class="math inline">\(A\)</span>, controlling for <span class="math inline">\(L\)</span>, using only the selected samples:</p>
<div class="cell">
<details>
<summary>Code</summary>
<div class="sourceCode cell-code" id="cb7"><pre class="sourceCode r code-with-copy"><code class="sourceCode r"><span id="cb7-1"><a href="#cb7-1" aria-hidden="true" tabindex="-1"></a><span class="co"># Data for the selected sample</span></span>
<span id="cb7-2"><a href="#cb7-2" aria-hidden="true" tabindex="-1"></a>dat.s <span class="ot">=</span> dat<span class="fl">.1</span> <span class="sc">%&gt;%</span> <span class="fu">filter</span>(S<span class="sc">==</span><span class="dv">1</span>)</span>
<span id="cb7-3"><a href="#cb7-3" aria-hidden="true" tabindex="-1"></a>N.s <span class="ot">=</span> <span class="fu">nrow</span>(dat.s)</span>
<span id="cb7-4"><a href="#cb7-4" aria-hidden="true" tabindex="-1"></a></span>
<span id="cb7-5"><a href="#cb7-5" aria-hidden="true" tabindex="-1"></a><span class="co"># Model for causal effect, with selected</span></span>
<span id="cb7-6"><a href="#cb7-6" aria-hidden="true" tabindex="-1"></a>mod.ate.s <span class="ot">=</span> <span class="fu">lm</span>(Y <span class="sc">~</span> A <span class="sc">+</span> L, <span class="at">data=</span>dat.s)</span>
<span id="cb7-7"><a href="#cb7-7" aria-hidden="true" tabindex="-1"></a><span class="fu">modelsummary</span>(<span class="fu">list</span>(<span class="st">"ATE(S=1)"</span> <span class="ot">=</span> mod.ate.s), </span>
<span id="cb7-8"><a href="#cb7-8" aria-hidden="true" tabindex="-1"></a>             <span class="at">statistic =</span> <span class="cn">NULL</span>,</span>
<span id="cb7-9"><a href="#cb7-9" aria-hidden="true" tabindex="-1"></a>             <span class="at">estimate  =</span> <span class="st">"{estimate}{stars} [{conf.low}, {conf.high}]"</span>) </span></code><button title="Copy to Clipboard" class="code-copy-button"><i class="bi"></i></button></pre></div>
</details>
<div class="cell-output-display">

<table class="table" style="width: auto !important; margin-left: auto; margin-right: auto;">
 <thead>
  <tr>
   <th style="text-align:left;">   </th>
   <th style="text-align:center;"> ATE(S=1) </th>
  </tr>
 </thead>
<tbody>
  <tr>
   <td style="text-align:left;"> (Intercept) </td>
   <td style="text-align:center;"> −1.341*** [−1.688, −0.995] </td>
  </tr>
  <tr>
   <td style="text-align:left;"> A </td>
   <td style="text-align:center;"> 0.516* [0.058, 0.974] </td>
  </tr>
  <tr>
   <td style="text-align:left;box-shadow: 0px 1px"> L </td>
   <td style="text-align:center;box-shadow: 0px 1px"> 1.843*** [1.601, 2.085] </td>
  </tr>
  <tr>
   <td style="text-align:left;"> Num.Obs. </td>
   <td style="text-align:center;"> 514 </td>
  </tr>
  <tr>
   <td style="text-align:left;"> R2 </td>
   <td style="text-align:center;"> 0.307 </td>
  </tr>
  <tr>
   <td style="text-align:left;"> R2 Adj. </td>
   <td style="text-align:center;"> 0.304 </td>
  </tr>
  <tr>
   <td style="text-align:left;"> AIC </td>
   <td style="text-align:center;"> 2458.1 </td>
  </tr>
  <tr>
   <td style="text-align:left;"> BIC </td>
   <td style="text-align:center;"> 2475.0 </td>
  </tr>
  <tr>
   <td style="text-align:left;"> Log.Lik. </td>
   <td style="text-align:center;"> −1225.026 </td>
  </tr>
  <tr>
   <td style="text-align:left;"> RMSE </td>
   <td style="text-align:center;"> 2.62 </td>
  </tr>
</tbody>
</table>

</div>
</div>
<p>The resulted 95% confidence interval for the coefficient of <span class="math inline">\(A\)</span>, using only samples for which <span class="math inline">\(S=1\)</span>, still covers the true ATE (0.75). Yet, a downwards bias shrinks the point-estimate and its lower bound noticeably. Using this, we would conclude the ATE is smaller than what truly is.</p>
<p>Let us implement an IPW-based approach to compare against:</p>
</section>
<section id="ipw-based-approach" class="level4">
<h4 class="anchored" data-anchor-id="ipw-based-approach">IPW-based approach:</h4>
<p>Given the SCM, and the assumption of <span class="math inline">\(\gamma_2=0\)</span>, we can express:</p>
<ul>
<li><p><span class="math inline">\(w_i=\mathbb{P}(S=1)/\mathbb{P}(S=1\mid A_i,L_i)\)</span></p></li>
<li><p><span class="math inline">\(v_i(a)=1/\mathbb{P}(A=a) = 1/q\)</span> because treatment is randomized</p></li>
</ul>
<p>The derived finite-sample estimator of the mean counterfactuals / potential outcomes is: <span class="math display">\[
\hat{Y}^a = N^{-1}\sum_{i=1}^N\frac{\mathbb{I}(A_i=a)\cdot\hat{\mathbb{P}}(S=1)}{\hat{\mathbb{P}}(A=a)\cdot\hat{\mathbb{P}}(S=1\mid A_i,L_i)}\cdot y_i
\]</span></p>
<p>Putting all ingredients together we get point-estimates <span class="math inline">\(\hat{Y}^1=\hat{\mathbb{E}}[Y\mid do(A=1)]\)</span> and <span class="math inline">\(\hat{Y}^0=\hat{\mathbb{E}}[Y\mid do(A=0)]\)</span>:</p>
<div class="cell">
<details>
<summary>Code</summary>
<div class="sourceCode cell-code" id="cb8"><pre class="sourceCode r code-with-copy"><code class="sourceCode r"><span id="cb8-1"><a href="#cb8-1" aria-hidden="true" tabindex="-1"></a><span class="co"># Compute the probability of selecton for all the units selected</span></span>
<span id="cb8-2"><a href="#cb8-2" aria-hidden="true" tabindex="-1"></a><span class="co"># We leverage the model mod.S, trained on complete data since S, A and L are</span></span>
<span id="cb8-3"><a href="#cb8-3" aria-hidden="true" tabindex="-1"></a><span class="co"># always observed (Y is the only one missing) and predict only on the selected units</span></span>
<span id="cb8-4"><a href="#cb8-4" aria-hidden="true" tabindex="-1"></a>prob.s.unit <span class="ot">=</span> <span class="fu">predict</span>(mod.S, <span class="at">newdata=</span>dat.s, <span class="at">type=</span><span class="st">'response'</span>)</span>
<span id="cb8-5"><a href="#cb8-5" aria-hidden="true" tabindex="-1"></a></span>
<span id="cb8-6"><a href="#cb8-6" aria-hidden="true" tabindex="-1"></a><span class="co"># The unconditional probability of selection can be consistently estimated </span></span>
<span id="cb8-7"><a href="#cb8-7" aria-hidden="true" tabindex="-1"></a><span class="co">#... with counts from the total sample size and selected sample size</span></span>
<span id="cb8-8"><a href="#cb8-8" aria-hidden="true" tabindex="-1"></a>prob.s <span class="ot">=</span> <span class="fu">nrow</span>(dat.s) <span class="sc">/</span> <span class="fu">nrow</span>(dat<span class="fl">.1</span>)</span>
<span id="cb8-9"><a href="#cb8-9" aria-hidden="true" tabindex="-1"></a></span>
<span id="cb8-10"><a href="#cb8-10" aria-hidden="true" tabindex="-1"></a><span class="co"># Since the treatment is randomized, the propensity score in the population is known at 0.5. </span></span>
<span id="cb8-11"><a href="#cb8-11" aria-hidden="true" tabindex="-1"></a><span class="co"># It can also be estimated from counts in the complete dataset</span></span>
<span id="cb8-12"><a href="#cb8-12" aria-hidden="true" tabindex="-1"></a><span class="co"># prop.score = sum(dat.1$A==1)/nrow(dat.1)</span></span>
<span id="cb8-13"><a href="#cb8-13" aria-hidden="true" tabindex="-1"></a>prop.score <span class="ot">=</span> <span class="fl">0.5</span></span>
<span id="cb8-14"><a href="#cb8-14" aria-hidden="true" tabindex="-1"></a></span>
<span id="cb8-15"><a href="#cb8-15" aria-hidden="true" tabindex="-1"></a><span class="co"># Estimated counterfactuals/potential outcomes via IPPW</span></span>
<span id="cb8-16"><a href="#cb8-16" aria-hidden="true" tabindex="-1"></a>est.PO <span class="ot">=</span> dat.s <span class="sc">%&gt;%</span> <span class="fu">mutate</span>(</span>
<span id="cb8-17"><a href="#cb8-17" aria-hidden="true" tabindex="-1"></a>  <span class="at">prob.s.unit =</span> <span class="fu">as.numeric</span>(prob.s.unit),</span>
<span id="cb8-18"><a href="#cb8-18" aria-hidden="true" tabindex="-1"></a>  <span class="at">prob.s =</span> <span class="fu">as.numeric</span>(prob.s),</span>
<span id="cb8-19"><a href="#cb8-19" aria-hidden="true" tabindex="-1"></a>  <span class="at">prop.score =</span> <span class="fu">as.numeric</span>(prop.score),</span>
<span id="cb8-20"><a href="#cb8-20" aria-hidden="true" tabindex="-1"></a>  <span class="at">pro.weight =</span> (A<span class="sc">/</span>prop.score) <span class="sc">+</span> (<span class="dv">1</span><span class="sc">-</span>A)<span class="sc">/</span>(<span class="dv">1</span><span class="sc">-</span>prop.score),</span>
<span id="cb8-21"><a href="#cb8-21" aria-hidden="true" tabindex="-1"></a>  <span class="at">weights =</span> pro.weight <span class="sc">*</span> prob.s <span class="sc">*</span> (<span class="dv">1</span><span class="sc">/</span>prob.s.unit),</span>
<span id="cb8-22"><a href="#cb8-22" aria-hidden="true" tabindex="-1"></a>  <span class="at">weighted.Y =</span> weights <span class="sc">*</span> Y) <span class="sc">%&gt;%</span> <span class="fu">group_by</span>(A) <span class="sc">%&gt;%</span> </span>
<span id="cb8-23"><a href="#cb8-23" aria-hidden="true" tabindex="-1"></a>  <span class="fu">summarise</span>(<span class="st">'PO'</span><span class="ot">=</span><span class="fu">sum</span>(weighted.Y)<span class="sc">/</span>N.s)</span>
<span id="cb8-24"><a href="#cb8-24" aria-hidden="true" tabindex="-1"></a></span>
<span id="cb8-25"><a href="#cb8-25" aria-hidden="true" tabindex="-1"></a><span class="co"># Print resulted estimates</span></span>
<span id="cb8-26"><a href="#cb8-26" aria-hidden="true" tabindex="-1"></a><span class="fu">head</span>(est.PO) <span class="sc">%&gt;%</span> <span class="fu">kbl</span>() <span class="sc">%&gt;%</span> <span class="fu">kable_styling</span>(<span class="at">full_width =</span> F)</span></code><button title="Copy to Clipboard" class="code-copy-button"><i class="bi"></i></button></pre></div>
</details>
<div class="cell-output-display">

<table class="table" style="width: auto !important; margin-left: auto; margin-right: auto;">
 <thead>
  <tr>
   <th style="text-align:right;"> A </th>
   <th style="text-align:right;"> PO </th>
  </tr>
 </thead>
<tbody>
  <tr>
   <td style="text-align:right;"> 0 </td>
   <td style="text-align:right;"> -1.4318076 </td>
  </tr>
  <tr>
   <td style="text-align:right;"> 1 </td>
   <td style="text-align:right;"> -0.7537995 </td>
  </tr>
</tbody>
</table>

</div>
</div>
<p>Which, can be used to compute a point-estimate of the ATE: <span class="math inline">\(\hat{ATE}=\hat{Y}^1-\hat{Y}^0\)</span>:</p>
<div class="cell">
<details>
<summary>Code</summary>
<div class="sourceCode cell-code" id="cb9"><pre class="sourceCode r code-with-copy"><code class="sourceCode r"><span id="cb9-1"><a href="#cb9-1" aria-hidden="true" tabindex="-1"></a><span class="co"># Print estimated ATE</span></span>
<span id="cb9-2"><a href="#cb9-2" aria-hidden="true" tabindex="-1"></a>est.ATE <span class="ot">=</span> <span class="fu">as.numeric</span>(est.PO[<span class="dv">2</span>,<span class="dv">2</span>]<span class="sc">-</span>est.PO[<span class="dv">1</span>,<span class="dv">2</span>])</span>
<span id="cb9-3"><a href="#cb9-3" aria-hidden="true" tabindex="-1"></a><span class="fu">data.frame</span>(<span class="st">'IPW ATE'</span><span class="ot">=</span>est.ATE) <span class="sc">%&gt;%</span> <span class="fu">kbl</span>() <span class="sc">%&gt;%</span> <span class="fu">kable_styling</span>(<span class="at">full_width =</span> F)</span></code><button title="Copy to Clipboard" class="code-copy-button"><i class="bi"></i></button></pre></div>
</details>
<div class="cell-output-display">

<table class="table" style="width: auto !important; margin-left: auto; margin-right: auto;">
 <thead>
  <tr>
   <th style="text-align:right;"> IPW.ATE </th>
  </tr>
 </thead>
<tbody>
  <tr>
   <td style="text-align:right;"> 0.678008 </td>
  </tr>
</tbody>
</table>

</div>
</div>
<p>We can see that the IPW-based approach produces a point-estimate closer to the true ATE. To get valid confidence intervals, however, a bootstrapping or asymptotic analysis need to be invoked. We can compute naïve confidence interval without resampling, using the fact:</p>
<p><span class="math display">\[
\hat{\text{var}}(\hat{\text{ATE}}) \geq \hat{\text{var}}(\hat{Y}^1)+\hat{\text{var}}(\hat{Y}^0)=(N-2)^{-2}\sum_{a\in\{0,1\}}\sum_{i=1}^N \mathbb{I}(A_i=a)\cdot \hat{v}_i(a)^2\hat{w}_i^2(Y_i-\hat{Y}^a)^2
\]</span>Such variance is naïve in the sense that it is overconfident due to ignoring the covariance between the potential outcomes, and the higher-order contributions of the weighting factors in the total variance. Anyway, using it will get us:</p>
<div class="cell">
<details>
<summary>Code</summary>
<div class="sourceCode cell-code" id="cb10"><pre class="sourceCode r code-with-copy"><code class="sourceCode r"><span id="cb10-1"><a href="#cb10-1" aria-hidden="true" tabindex="-1"></a><span class="co"># Estimated counterfactuals/potential outcomes via IPPW</span></span>
<span id="cb10-2"><a href="#cb10-2" aria-hidden="true" tabindex="-1"></a>sd.PO <span class="ot">=</span> dat.s <span class="sc">%&gt;%</span> <span class="fu">mutate</span>(</span>
<span id="cb10-3"><a href="#cb10-3" aria-hidden="true" tabindex="-1"></a>  <span class="at">prob.s.unit =</span> <span class="fu">as.numeric</span>(prob.s.unit),</span>
<span id="cb10-4"><a href="#cb10-4" aria-hidden="true" tabindex="-1"></a>  <span class="at">prob.s =</span> <span class="fu">as.numeric</span>(prob.s),</span>
<span id="cb10-5"><a href="#cb10-5" aria-hidden="true" tabindex="-1"></a>  <span class="at">prop.score =</span> <span class="fu">as.numeric</span>(prop.score),</span>
<span id="cb10-6"><a href="#cb10-6" aria-hidden="true" tabindex="-1"></a>  <span class="at">pro.weight =</span> (A<span class="sc">/</span>prop.score) <span class="sc">+</span> (<span class="dv">1</span><span class="sc">-</span>A)<span class="sc">/</span>(<span class="dv">1</span><span class="sc">-</span>prop.score),</span>
<span id="cb10-7"><a href="#cb10-7" aria-hidden="true" tabindex="-1"></a>  <span class="at">weights =</span> pro.weight <span class="sc">*</span> prob.s <span class="sc">*</span> (<span class="dv">1</span><span class="sc">/</span>prob.s.unit),</span>
<span id="cb10-8"><a href="#cb10-8" aria-hidden="true" tabindex="-1"></a>  <span class="at">weighted.var =</span> weights<span class="sc">^</span><span class="dv">2</span> <span class="sc">*</span> ( A<span class="sc">*</span> (Y<span class="sc">-</span>est.PO[<span class="dv">2</span>,<span class="dv">2</span>])<span class="sc">^</span><span class="dv">2</span> <span class="sc">+</span> (<span class="dv">1</span><span class="sc">-</span>A)<span class="sc">*</span> (Y<span class="sc">-</span>est.PO[<span class="dv">1</span>,<span class="dv">2</span>])<span class="sc">^</span><span class="dv">2</span>)) <span class="sc">%&gt;%</span> </span>
<span id="cb10-9"><a href="#cb10-9" aria-hidden="true" tabindex="-1"></a>  <span class="fu">group_by</span>(A) <span class="sc">%&gt;%</span> </span>
<span id="cb10-10"><a href="#cb10-10" aria-hidden="true" tabindex="-1"></a>  <span class="fu">summarise</span>(<span class="st">'sd'</span><span class="ot">=</span><span class="fu">sqrt</span>(<span class="fu">sum</span>(weighted.var))<span class="sc">/</span>(N.s<span class="dv">-2</span>))</span>
<span id="cb10-11"><a href="#cb10-11" aria-hidden="true" tabindex="-1"></a></span>
<span id="cb10-12"><a href="#cb10-12" aria-hidden="true" tabindex="-1"></a><span class="co"># Naïve confidence interval</span></span>
<span id="cb10-13"><a href="#cb10-13" aria-hidden="true" tabindex="-1"></a>naivebounds <span class="ot">=</span> <span class="fu">qnorm</span>(<span class="fl">0.975</span>)<span class="sc">*</span><span class="fu">sum</span>(sd.PO[,<span class="dv">2</span>])</span>
<span id="cb10-14"><a href="#cb10-14" aria-hidden="true" tabindex="-1"></a><span class="fu">data.frame</span>(<span class="st">'IPW ATE'</span><span class="ot">=</span><span class="fu">as.numeric</span>(est.ATE),</span>
<span id="cb10-15"><a href="#cb10-15" aria-hidden="true" tabindex="-1"></a>           <span class="st">'naïve LB'</span><span class="ot">=</span><span class="fu">as.numeric</span>(est.ATE)<span class="sc">-</span>naivebounds,</span>
<span id="cb10-16"><a href="#cb10-16" aria-hidden="true" tabindex="-1"></a>           <span class="st">'naïve UB'</span><span class="ot">=</span><span class="fu">as.numeric</span>(est.ATE)<span class="sc">+</span>naivebounds) <span class="sc">%&gt;%</span> <span class="fu">kbl</span>() <span class="sc">%&gt;%</span> <span class="fu">kable_styling</span>(<span class="at">full_width =</span> F)</span></code><button title="Copy to Clipboard" class="code-copy-button"><i class="bi"></i></button></pre></div>
</details>
<div class="cell-output-display">

<table class="table" style="width: auto !important; margin-left: auto; margin-right: auto;">
 <thead>
  <tr>
   <th style="text-align:right;"> IPW.ATE </th>
   <th style="text-align:right;"> naïve.LB </th>
   <th style="text-align:right;"> naïve.UB </th>
  </tr>
 </thead>
<tbody>
  <tr>
   <td style="text-align:right;"> 0.678008 </td>
   <td style="text-align:right;"> 0.5741569 </td>
   <td style="text-align:right;"> 0.7818592 </td>
  </tr>
</tbody>
</table>

</div>
</div>
<p>As noted, the naïve confidence interval is tighter than those produced by inference on the complete data. This means such confidence interval is not statistically valid, but it can still help us visualize the convergence of IPW estimator.</p>
<p>Now, if we simulate and repeat the DGP and same analysis for different sample sizes, consistency would be visually perceived if we see:</p>
<ul>
<li><p>Point-estimate converging to the true ATE</p></li>
<li><p>Confidence intervals shrinking at a fast (**) rate</p></li>
</ul>
<p>Let us test it. We run 20 simulations with different complete sample sizes, from <span class="math inline">\(N=500\)</span> to <span class="math inline">\(N=23\,000\)</span> [number of complete samples from <span class="math inline">\(N_s=250\)</span> to <span class="math inline">\(N_s=12\,000\)</span>]. We repeat the procedure three times and average the results on those three repetitions. Such averages are presented in the following table:</p>
<div class="cell">
<details>
<summary>Code</summary>
<div class="sourceCode cell-code" id="cb11"><pre class="sourceCode r code-with-copy"><code class="sourceCode r"><span id="cb11-1"><a href="#cb11-1" aria-hidden="true" tabindex="-1"></a><span class="co"># Data frame to save results from iterations</span></span>
<span id="cb11-2"><a href="#cb11-2" aria-hidden="true" tabindex="-1"></a>rounds.IPPW <span class="ot">=</span> <span class="fu">data.frame</span>(<span class="at">N=</span><span class="cn">NA</span>, <span class="at">Ns=</span><span class="cn">NA</span>, <span class="at">EST=</span><span class="cn">NA</span>, <span class="at">LB=</span><span class="cn">NA</span>, <span class="at">UB=</span><span class="cn">NA</span>)</span>
<span id="cb11-3"><a href="#cb11-3" aria-hidden="true" tabindex="-1"></a></span>
<span id="cb11-4"><a href="#cb11-4" aria-hidden="true" tabindex="-1"></a><span class="co"># All sample sizes to consider</span></span>
<span id="cb11-5"><a href="#cb11-5" aria-hidden="true" tabindex="-1"></a>samplesizes <span class="ot">=</span> <span class="fu">round</span>(<span class="dv">500</span><span class="sc">*</span><span class="fu">exp</span>(<span class="fl">0.2</span><span class="sc">*</span>(<span class="dv">0</span><span class="sc">:</span><span class="dv">19</span>)))</span>
<span id="cb11-6"><a href="#cb11-6" aria-hidden="true" tabindex="-1"></a></span>
<span id="cb11-7"><a href="#cb11-7" aria-hidden="true" tabindex="-1"></a><span class="co"># Number of repetitions</span></span>
<span id="cb11-8"><a href="#cb11-8" aria-hidden="true" tabindex="-1"></a>M <span class="ot">=</span> <span class="dv">3</span></span>
<span id="cb11-9"><a href="#cb11-9" aria-hidden="true" tabindex="-1"></a></span>
<span id="cb11-10"><a href="#cb11-10" aria-hidden="true" tabindex="-1"></a><span class="co"># Paramaters are the same as before</span></span>
<span id="cb11-11"><a href="#cb11-11" aria-hidden="true" tabindex="-1"></a>param.iter <span class="ot">=</span> param<span class="fl">.1</span></span>
<span id="cb11-12"><a href="#cb11-12" aria-hidden="true" tabindex="-1"></a></span>
<span id="cb11-13"><a href="#cb11-13" aria-hidden="true" tabindex="-1"></a><span class="co"># Seed</span></span>
<span id="cb11-14"><a href="#cb11-14" aria-hidden="true" tabindex="-1"></a><span class="fu">set.seed</span>(<span class="dv">66</span>)</span>
<span id="cb11-15"><a href="#cb11-15" aria-hidden="true" tabindex="-1"></a></span>
<span id="cb11-16"><a href="#cb11-16" aria-hidden="true" tabindex="-1"></a><span class="co"># Loop</span></span>
<span id="cb11-17"><a href="#cb11-17" aria-hidden="true" tabindex="-1"></a><span class="cf">for</span>(m <span class="cf">in</span> <span class="dv">1</span><span class="sc">:</span>M){</span>
<span id="cb11-18"><a href="#cb11-18" aria-hidden="true" tabindex="-1"></a>  <span class="cf">for</span>(n <span class="cf">in</span> samplesizes){</span>
<span id="cb11-19"><a href="#cb11-19" aria-hidden="true" tabindex="-1"></a>    </span>
<span id="cb11-20"><a href="#cb11-20" aria-hidden="true" tabindex="-1"></a>    <span class="co"># Change sample size</span></span>
<span id="cb11-21"><a href="#cb11-21" aria-hidden="true" tabindex="-1"></a>    param.iter[<span class="dv">1</span>] <span class="ot">=</span> n</span>
<span id="cb11-22"><a href="#cb11-22" aria-hidden="true" tabindex="-1"></a>    </span>
<span id="cb11-23"><a href="#cb11-23" aria-hidden="true" tabindex="-1"></a>    <span class="co"># Generate the data (complete and selected)</span></span>
<span id="cb11-24"><a href="#cb11-24" aria-hidden="true" tabindex="-1"></a>    dat.iter <span class="ot">=</span> <span class="fu">dgp</span>(param.iter)[[<span class="dv">1</span>]]</span>
<span id="cb11-25"><a href="#cb11-25" aria-hidden="true" tabindex="-1"></a>    dat.s.iter <span class="ot">=</span> dat.iter <span class="sc">%&gt;%</span> <span class="fu">filter</span>(S<span class="sc">==</span><span class="dv">1</span>)</span>
<span id="cb11-26"><a href="#cb11-26" aria-hidden="true" tabindex="-1"></a>    </span>
<span id="cb11-27"><a href="#cb11-27" aria-hidden="true" tabindex="-1"></a>    <span class="co"># Estimated probability of selection</span></span>
<span id="cb11-28"><a href="#cb11-28" aria-hidden="true" tabindex="-1"></a>    N.s.iter <span class="ot">=</span> <span class="fu">nrow</span>(dat.s.iter)</span>
<span id="cb11-29"><a href="#cb11-29" aria-hidden="true" tabindex="-1"></a>    prob.s.iter <span class="ot">=</span> N.s.iter <span class="sc">/</span> n</span>
<span id="cb11-30"><a href="#cb11-30" aria-hidden="true" tabindex="-1"></a>    </span>
<span id="cb11-31"><a href="#cb11-31" aria-hidden="true" tabindex="-1"></a>    <span class="co"># Model for S, with complete data</span></span>
<span id="cb11-32"><a href="#cb11-32" aria-hidden="true" tabindex="-1"></a>    mod.S.iter <span class="ot">=</span> <span class="fu">glm</span>(S <span class="sc">~</span> A <span class="sc">+</span> L, <span class="at">family=</span><span class="fu">binomial</span>(<span class="st">'probit'</span>), <span class="at">data=</span>dat.iter)</span>
<span id="cb11-33"><a href="#cb11-33" aria-hidden="true" tabindex="-1"></a>    prob.s.unit.iter <span class="ot">=</span> <span class="fu">predict</span>(mod.S.iter, <span class="at">newdata=</span>dat.s.iter, <span class="at">type=</span><span class="st">'response'</span>)</span>
<span id="cb11-34"><a href="#cb11-34" aria-hidden="true" tabindex="-1"></a>  </span>
<span id="cb11-35"><a href="#cb11-35" aria-hidden="true" tabindex="-1"></a>    <span class="co"># Propensity score model</span></span>
<span id="cb11-36"><a href="#cb11-36" aria-hidden="true" tabindex="-1"></a>    prop.score.iter <span class="ot">=</span> <span class="fu">sum</span>(dat.iter<span class="sc">$</span>A<span class="sc">==</span><span class="dv">1</span>)<span class="sc">/</span><span class="fu">nrow</span>(dat.iter)</span>
<span id="cb11-37"><a href="#cb11-37" aria-hidden="true" tabindex="-1"></a>    </span>
<span id="cb11-38"><a href="#cb11-38" aria-hidden="true" tabindex="-1"></a>    <span class="co"># Put everything together</span></span>
<span id="cb11-39"><a href="#cb11-39" aria-hidden="true" tabindex="-1"></a>    row.iter <span class="ot">=</span> dat.s.iter <span class="sc">%&gt;%</span> <span class="fu">mutate</span>(</span>
<span id="cb11-40"><a href="#cb11-40" aria-hidden="true" tabindex="-1"></a>      <span class="at">prob.s.unit =</span> <span class="fu">as.numeric</span>(prob.s.unit.iter),</span>
<span id="cb11-41"><a href="#cb11-41" aria-hidden="true" tabindex="-1"></a>      <span class="at">prob.s =</span> <span class="fu">as.numeric</span>(prob.s.iter),</span>
<span id="cb11-42"><a href="#cb11-42" aria-hidden="true" tabindex="-1"></a>      <span class="at">prop.score =</span> <span class="fu">as.numeric</span>(prop.score.iter),</span>
<span id="cb11-43"><a href="#cb11-43" aria-hidden="true" tabindex="-1"></a>      <span class="at">pro.weight =</span> (A<span class="sc">/</span>prop.score) <span class="sc">+</span> (<span class="dv">1</span><span class="sc">-</span>A)<span class="sc">/</span>(<span class="dv">1</span><span class="sc">-</span>prop.score),</span>
<span id="cb11-44"><a href="#cb11-44" aria-hidden="true" tabindex="-1"></a>      <span class="at">weights =</span> pro.weight <span class="sc">*</span> prob.s <span class="sc">*</span> (<span class="dv">1</span><span class="sc">/</span>prob.s.unit),</span>
<span id="cb11-45"><a href="#cb11-45" aria-hidden="true" tabindex="-1"></a>      <span class="at">weighted.Y =</span> weights <span class="sc">*</span> Y) </span>
<span id="cb11-46"><a href="#cb11-46" aria-hidden="true" tabindex="-1"></a>    </span>
<span id="cb11-47"><a href="#cb11-47" aria-hidden="true" tabindex="-1"></a>    <span class="co"># Estimated counterfactuals/potential outcomes via IPPW</span></span>
<span id="cb11-48"><a href="#cb11-48" aria-hidden="true" tabindex="-1"></a>    po.iter <span class="ot">=</span> row.iter <span class="sc">%&gt;%</span> <span class="fu">group_by</span>(A) <span class="sc">%&gt;%</span> </span>
<span id="cb11-49"><a href="#cb11-49" aria-hidden="true" tabindex="-1"></a>      <span class="fu">summarise</span>(<span class="st">'Y(A)'</span><span class="ot">=</span><span class="fu">sum</span>(weighted.Y)<span class="sc">/</span>N.s.iter)</span>
<span id="cb11-50"><a href="#cb11-50" aria-hidden="true" tabindex="-1"></a>    </span>
<span id="cb11-51"><a href="#cb11-51" aria-hidden="true" tabindex="-1"></a>    <span class="co"># Estimated ATE</span></span>
<span id="cb11-52"><a href="#cb11-52" aria-hidden="true" tabindex="-1"></a>    ATE.iter <span class="ot">=</span> <span class="fu">as.numeric</span>(po.iter[<span class="dv">2</span>,<span class="dv">2</span>]<span class="sc">-</span>po.iter[<span class="dv">1</span>,<span class="dv">2</span>])</span>
<span id="cb11-53"><a href="#cb11-53" aria-hidden="true" tabindex="-1"></a>    </span>
<span id="cb11-54"><a href="#cb11-54" aria-hidden="true" tabindex="-1"></a>    <span class="co"># Naïve variances</span></span>
<span id="cb11-55"><a href="#cb11-55" aria-hidden="true" tabindex="-1"></a>    sd.PO.iter <span class="ot">=</span> row.iter <span class="sc">%&gt;%</span> <span class="fu">mutate</span>(</span>
<span id="cb11-56"><a href="#cb11-56" aria-hidden="true" tabindex="-1"></a>      <span class="at">weighted.var =</span> weights<span class="sc">^</span><span class="dv">2</span> <span class="sc">*</span> ( A<span class="sc">*</span> (Y<span class="sc">-</span>po.iter[<span class="dv">2</span>,<span class="dv">2</span>])<span class="sc">^</span><span class="dv">2</span> <span class="sc">+</span> (<span class="dv">1</span><span class="sc">-</span>A)<span class="sc">*</span> (Y<span class="sc">-</span>po.iter[<span class="dv">1</span>,<span class="dv">2</span>])<span class="sc">^</span><span class="dv">2</span>)) <span class="sc">%&gt;%</span> </span>
<span id="cb11-57"><a href="#cb11-57" aria-hidden="true" tabindex="-1"></a>    <span class="fu">group_by</span>(A) <span class="sc">%&gt;%</span> </span>
<span id="cb11-58"><a href="#cb11-58" aria-hidden="true" tabindex="-1"></a>    <span class="fu">summarise</span>(<span class="st">'sd'</span><span class="ot">=</span><span class="fu">sqrt</span>(<span class="fu">sum</span>(weighted.var))<span class="sc">/</span>(N.s.iter<span class="dv">-1</span>))</span>
<span id="cb11-59"><a href="#cb11-59" aria-hidden="true" tabindex="-1"></a>    </span>
<span id="cb11-60"><a href="#cb11-60" aria-hidden="true" tabindex="-1"></a>    <span class="co"># Naïve confidence interval</span></span>
<span id="cb11-61"><a href="#cb11-61" aria-hidden="true" tabindex="-1"></a>    naivebounds <span class="ot">=</span> <span class="fu">qnorm</span>(<span class="fl">0.975</span>)<span class="sc">*</span><span class="fu">sum</span>(sd.PO.iter[,<span class="dv">2</span>])</span>
<span id="cb11-62"><a href="#cb11-62" aria-hidden="true" tabindex="-1"></a>    </span>
<span id="cb11-63"><a href="#cb11-63" aria-hidden="true" tabindex="-1"></a>    rounds.IPPW <span class="ot">=</span> <span class="fu">rbind.data.frame</span>(rounds.IPPW,</span>
<span id="cb11-64"><a href="#cb11-64" aria-hidden="true" tabindex="-1"></a>                                   <span class="fu">data.frame</span>(<span class="at">N=</span>n,</span>
<span id="cb11-65"><a href="#cb11-65" aria-hidden="true" tabindex="-1"></a>                                              <span class="at">Ns=</span>N.s.iter,</span>
<span id="cb11-66"><a href="#cb11-66" aria-hidden="true" tabindex="-1"></a>                                              <span class="at">EST=</span>ATE.iter,</span>
<span id="cb11-67"><a href="#cb11-67" aria-hidden="true" tabindex="-1"></a>                                              <span class="at">LB=</span>ATE.iter<span class="sc">-</span>naivebounds,</span>
<span id="cb11-68"><a href="#cb11-68" aria-hidden="true" tabindex="-1"></a>                                              <span class="at">UB=</span>ATE.iter<span class="sc">+</span>naivebounds))</span>
<span id="cb11-69"><a href="#cb11-69" aria-hidden="true" tabindex="-1"></a>  }</span>
<span id="cb11-70"><a href="#cb11-70" aria-hidden="true" tabindex="-1"></a>}</span>
<span id="cb11-71"><a href="#cb11-71" aria-hidden="true" tabindex="-1"></a><span class="co"># Print resulted estimates</span></span>
<span id="cb11-72"><a href="#cb11-72" aria-hidden="true" tabindex="-1"></a>rounds.IPPW <span class="ot">=</span> rounds.IPPW[<span class="sc">-</span><span class="dv">1</span>,] <span class="sc">%&gt;%</span></span>
<span id="cb11-73"><a href="#cb11-73" aria-hidden="true" tabindex="-1"></a>  <span class="fu">group_by</span>(N) <span class="sc">%&gt;%</span></span>
<span id="cb11-74"><a href="#cb11-74" aria-hidden="true" tabindex="-1"></a>  <span class="fu">summarise_all</span>(mean)</span>
<span id="cb11-75"><a href="#cb11-75" aria-hidden="true" tabindex="-1"></a></span>
<span id="cb11-76"><a href="#cb11-76" aria-hidden="true" tabindex="-1"></a><span class="fu">head</span>(rounds.IPPW) <span class="sc">%&gt;%</span> <span class="fu">kbl</span>() <span class="sc">%&gt;%</span> <span class="fu">kable_styling</span>(<span class="at">full_width =</span> F)</span></code><button title="Copy to Clipboard" class="code-copy-button"><i class="bi"></i></button></pre></div>
</details>
<div class="cell-output-display">

<table class="table" style="width: auto !important; margin-left: auto; margin-right: auto;">
 <thead>
  <tr>
   <th style="text-align:right;"> N </th>
   <th style="text-align:right;"> Ns </th>
   <th style="text-align:right;"> EST </th>
   <th style="text-align:right;"> LB </th>
   <th style="text-align:right;"> UB </th>
  </tr>
 </thead>
<tbody>
  <tr>
   <td style="text-align:right;"> 500 </td>
   <td style="text-align:right;"> 249.6667 </td>
   <td style="text-align:right;"> 0.5919352 </td>
   <td style="text-align:right;"> -0.1461034 </td>
   <td style="text-align:right;"> 1.3299737 </td>
  </tr>
  <tr>
   <td style="text-align:right;"> 611 </td>
   <td style="text-align:right;"> 309.0000 </td>
   <td style="text-align:right;"> 0.7701710 </td>
   <td style="text-align:right;"> 0.1782066 </td>
   <td style="text-align:right;"> 1.3621354 </td>
  </tr>
  <tr>
   <td style="text-align:right;"> 746 </td>
   <td style="text-align:right;"> 379.6667 </td>
   <td style="text-align:right;"> 0.8962619 </td>
   <td style="text-align:right;"> 0.2991885 </td>
   <td style="text-align:right;"> 1.4933353 </td>
  </tr>
  <tr>
   <td style="text-align:right;"> 911 </td>
   <td style="text-align:right;"> 453.6667 </td>
   <td style="text-align:right;"> 0.7438565 </td>
   <td style="text-align:right;"> 0.5811669 </td>
   <td style="text-align:right;"> 0.9065460 </td>
  </tr>
  <tr>
   <td style="text-align:right;"> 1113 </td>
   <td style="text-align:right;"> 556.0000 </td>
   <td style="text-align:right;"> 0.7817429 </td>
   <td style="text-align:right;"> 0.3579693 </td>
   <td style="text-align:right;"> 1.2055165 </td>
  </tr>
  <tr>
   <td style="text-align:right;"> 1359 </td>
   <td style="text-align:right;"> 679.0000 </td>
   <td style="text-align:right;"> 0.6411555 </td>
   <td style="text-align:right;"> 0.3223225 </td>
   <td style="text-align:right;"> 0.9599884 </td>
  </tr>
</tbody>
</table>

</div>
</div>
<p>An the following plot:</p>
<div class="cell">
<details>
<summary>Code</summary>
<div class="sourceCode cell-code" id="cb12"><pre class="sourceCode r code-with-copy"><code class="sourceCode r"><span id="cb12-1"><a href="#cb12-1" aria-hidden="true" tabindex="-1"></a><span class="do">### Plot results from rounds</span></span>
<span id="cb12-2"><a href="#cb12-2" aria-hidden="true" tabindex="-1"></a>rounds.IPPW[,<span class="sc">-</span><span class="dv">1</span>] <span class="sc">%&gt;%</span> <span class="fu">melt</span>(<span class="at">id.vars =</span> <span class="st">'Ns'</span>) <span class="sc">%&gt;%</span> </span>
<span id="cb12-3"><a href="#cb12-3" aria-hidden="true" tabindex="-1"></a>  <span class="fu">mutate</span>(<span class="at">type =</span> <span class="fu">ifelse</span>(variable<span class="sc">==</span><span class="st">'EST'</span>,<span class="st">'EST'</span>,<span class="st">'N. C.I.'</span>) ) <span class="sc">%&gt;%</span> </span>
<span id="cb12-4"><a href="#cb12-4" aria-hidden="true" tabindex="-1"></a>  <span class="fu">ggplot</span>(<span class="fu">aes</span>(<span class="at">x=</span>Ns,<span class="at">y=</span>value,<span class="at">group=</span>variable)) <span class="sc">+</span> </span>
<span id="cb12-5"><a href="#cb12-5" aria-hidden="true" tabindex="-1"></a>  <span class="fu">geom_point</span>(<span class="fu">aes</span>(<span class="at">shape=</span>type,<span class="at">color=</span>type)) <span class="sc">+</span> </span>
<span id="cb12-6"><a href="#cb12-6" aria-hidden="true" tabindex="-1"></a>  <span class="fu">geom_smooth</span>(<span class="at">method =</span> lm, <span class="at">formula =</span> y <span class="sc">~</span> x <span class="sc">+</span> <span class="fu">I</span>(<span class="fu">log</span>(x)), <span class="at">se =</span> <span class="cn">FALSE</span>) <span class="sc">+</span></span>
<span id="cb12-7"><a href="#cb12-7" aria-hidden="true" tabindex="-1"></a>  <span class="fu">labs</span>(<span class="at">y=</span><span class="st">'Value of estimate / bound'</span>, <span class="at">x=</span><span class="st">'number of complete samples'</span>) <span class="sc">+</span></span>
<span id="cb12-8"><a href="#cb12-8" aria-hidden="true" tabindex="-1"></a>  <span class="fu">geom_hline</span>(<span class="at">yintercept=</span>T.ATE, <span class="at">col =</span> <span class="st">'red'</span>) <span class="sc">+</span></span>
<span id="cb12-9"><a href="#cb12-9" aria-hidden="true" tabindex="-1"></a>  <span class="fu">theme_bw</span>()</span></code><button title="Copy to Clipboard" class="code-copy-button"><i class="bi"></i></button></pre></div>
</details>
<div class="cell-output-display">
<p><img src="index_files/figure-html/unnamed-chunk-13-1.png" class="img-fluid" width="720"></p>
</div>
</div>
<p>We can appreciate that the estimator converges to the true ATE [in red], and its uncertainty reduce at a sustained rate; there is <strong>convergence in probability</strong>. In other words, the IPW-based estimator is consistent.</p>
<section id="mathematical-justification-of-consistency" class="level5">
<h5 class="anchored" data-anchor-id="mathematical-justification-of-consistency">Mathematical justification of consistency</h5>
<p>We can prove consistency mathematically for this SCM. However, to avoid measure-theoretic conundrums, let us consider the case for which all variables are discrete. Results are generalizable for mixed discrete-continuous cases with positive distributions (no zero-measure events).</p>
<p>Let us assume <span class="math inline">\(Y\)</span> has support on <span class="math inline">\(\{y_{(c)}\}_{c=1}^C\)</span>, and <span class="math inline">\(L\)</span> has support on <span class="math inline">\(\{l_{(k)}\}_{k=1}^K\)</span>, then:</p>
<p><span class="math display">\[
\begin{aligned}
\hat{Y}^a &amp;= N^{-1}\sum_{i=1}^N\frac{\hat{\mathbb{P}}(S=1)}{\hat{\mathbb{P}}(A=a)\cdot\hat{\mathbb{P}}(S=1\mid A=a_i,L=l_i)}\cdot y_i\cdot \mathbb{I}(A_i=a) \\
&amp;=
N^{-1}\sum_{i=1}^N\frac{\hat{\mathbb{P}}(S=1)}{\hat{\mathbb{P}}(A=a\mid L=l_i)\cdot\hat{\mathbb{P}}(S=1\mid A=a,L=l_i)}\cdot y_i\cdot\mathbb{I}(A_i=a,S_i=1)\\
&amp;=
\sum_{i=1}^N
\frac{\hat{\mathbb{P}}(S=1)}{
\hat{\mathbb{P}}(S=1\mid L=l_i)
}\cdot
\frac{
y_i\cdot\mathbb{I}(A_i=a,S_i=1)/N}{
\hat{\mathbb{P}}(A=a\mid L=l_i,S=1)
}\\
&amp;= \sum_{i=1}^N\sum_{k}\sum_{c}
\frac{\hat{\mathbb{P}}(S=1)}{
\hat{\mathbb{P}}(S=1\mid L=l_{(k)})
}\cdot
\frac{
y_{i}\cdot\mathbb{I}(A_i=a,L_i=l_{(k)},S_i=1)/N}{
\hat{\mathbb{P}}(A=a\mid L=l_{(k)},S=1)
}\\
&amp;= \sum_{k}\sum_{c}
\frac{\hat{\mathbb{P}}(S=1)}{
\hat{\mathbb{P}}(S=1\mid L=l_{(k)})
}\cdot
\frac{
y_{(c)}\cdot\sum_{i=1}^N\mathbb{I}(Y_i=y_{(c)},A_i=a,L_i=l_{(k)},S_i=1)/N}{
\hat{\mathbb{P}}(A=a\mid L=l_{(k)},S=1)
}\\
&amp;= \sum_{k}\sum_{c}
\frac{\hat{\mathbb{P}}(S=1)}{
\hat{\mathbb{P}}(S=1\mid L=l_{(k)})
}\cdot
\frac{
y_{(c)}\cdot\hat{\mathbb{P}}(Y=y_{(c)},A=a,L=l_{(k)}\mid S=1)}{
\hat{\mathbb{P}}(A=a\mid L=l_{(k)},S=1)
}
\end{aligned}
\]</span></p>
<p>Assuming the propensity scores and the probability of selection are both correctly specified, all finite-sample approximations <span class="math inline">\(\hat{\mathbb{P}}\)</span> converge in the limit to the true distributions <span class="math inline">\(\mathbb{P}\)</span>. Then:</p>
<p><span class="math display">\[
\begin{aligned}
\text{plim}_{N\rightarrow\infty}
\hat{Y}^a
&amp;=
\sum_{k}\sum_{c}
\frac{{\mathbb{P}}(S=1)}{
{\mathbb{P}}(S=1\mid L=l_{(k)})
}\cdot
\frac{
y_{(c)}\cdot{\mathbb{P}}(Y=y_{(c)},A=a,L=l_{(k)}\mid S=1)}{
{\mathbb{P}}(A=a\mid L=l_{(k)},S=1)
}\\
&amp;=
\sum_{k}\sum_{c}
\frac{{\mathbb{P}}(L=l_{(k)})}{
{\mathbb{P}}(L=l_{(k)}\mid S=1)
}\cdot
\frac{
y_{(c)}\cdot{\mathbb{P}}(Y=y_{(c)},A=a,L=l_{(k)}\mid S=1)}{
{\mathbb{P}}(A=a\mid L=l_{(k)},S=1)
}\\
&amp;=
\sum_{k}\sum_{c}
{\mathbb{P}}(L=l_{(k)})
\cdot
y_{(c)}\cdot{\mathbb{P}}(Y=y_{(c)}\mid A=a,L=l_{(k)} S=1)\\
&amp;=
\sum_{k}
{\mathbb{P}}(L=l_{(k)})
\sum_{c}
y_{(c)}\cdot{\mathbb{P}}(Y=y_{(c)}\mid A=a,L=l_{(k)}, S=1)\\
&amp;=
\sum_{k}
{\mathbb{P}}(L=l_{(k)})
\mathbb{E}(Y\mid A=a,L, S=1)\\
&amp;=
\mathbb{E}_L
\mathbb{E}(Y\mid A=a,L, S=1) =\mathbb{E}[Y\mid do(A=a)]
\end{aligned}
\]</span></p>
<p>This is, the IPW estimator converges to the true counterfactual mean given by intervention <span class="math inline">\(do(A=a)\)</span>. The last equality comes from two facts:</p>
<ul>
<li><p><span class="math inline">\(L\)</span> blocks all backdoor paths from <span class="math inline">\(A\)</span> to <span class="math inline">\(Y\)</span> when conditioning on <span class="math inline">\(S=1\)</span></p></li>
<li><p><span class="math inline">\(\mathbb{P}(L=l_{(k)})\)</span> is the population-distribution of <span class="math inline">\(L\)</span></p></li>
</ul>
<hr>
</section>
</section>
</section>
</section>
<section id="case-2-selection-does-depend-on-a-mediator" class="level2">
<h2 class="anchored" data-anchor-id="case-2-selection-does-depend-on-a-mediator">Case 2: Selection does depend on a mediator</h2>
<p>This case is equivalent to setting <span class="math inline">\(\gamma_2\neq 0\)</span> in the SCM. To analyse this case let us leverage the accumulated knowledge for the previous case, in combination with the particularities of the new case:</p>
<section id="regression-based-approach-1" class="level4">
<h4 class="anchored" data-anchor-id="regression-based-approach-1">Regression-based approach</h4>
<p>A regression-based approach using only the selected samples would not work, because:</p>
<ul>
<li><p>As before, conditioning on <span class="math inline">\(S\)</span> opens some backdoor paths between treatment and outcome that could be blocked by <span class="math inline">\(L\)</span>, but its distribution differs in the sample from the population.</p></li>
<li><p>A new backdoor path opens: <span class="math inline">\(A\longleftrightarrow u_s\longleftrightarrow M\longrightarrow Y\)</span>, where <span class="math inline">\(S\)</span> acts as a virtual collider. This path, however, cannot be blocked by any valid adjustment set. Trying to block it with <span class="math inline">\(M\)</span> introduces bias by conditioning on a mediator.</p></li>
</ul>
</section>
<section id="ipw-based-approach-1" class="level4">
<h4 class="anchored" data-anchor-id="ipw-based-approach-1">IPW-based approach</h4>
<p>Here is where our original analysis question pops up:</p>
<blockquote class="blockquote">
<p><em>Is the IPW estimator still consistent if the probability of selection depends on a mediator of the causal effect?</em></p>
</blockquote>
<p>Consider this:</p>
<ul>
<li><p>For the IPW estimator being consistent the propensity score and the probability of selection <strong>must be jointly correctly specified</strong>. Since in our case the treatment assignment is randomized, the propensity score (either known or nonparametrically estimated with counts) is in fact correctly specified. This implies all responsibility for consistency lies on the model for the probability of selection.</p></li>
<li><p>We know that the probability of selection depends on <span class="math inline">\(M\)</span>, so for its model to be correctly specified it must use <span class="math inline">\(M\)</span>.</p></li>
</ul>
<p>The question is then, will using <span class="math inline">\(M\)</span> to model the probability of selection lead us to a consistent estimator for the ATE?</p>
<p>We will continue the analysis in another entry: <strong>part 2</strong></p>



</section>
</section>
</section>

<div id="quarto-appendix" class="default"><section class="quarto-appendix-contents" role="doc-bibliography"><h2 class="anchored quarto-appendix-heading">References</h2><div id="refs" class="references csl-bib-body hanging-indent" role="doc-bibliography">
<div id="ref-pearl2009" class="csl-entry" role="doc-biblioentry">
Pearl, Judea. 2009. <span>“Causality,”</span> September. <a href="https://doi.org/10.1017/cbo9780511803161">https://doi.org/10.1017/cbo9780511803161</a>.
</div>
</div></section></div></main> <!-- /main -->
<script id="quarto-html-after-body" type="application/javascript">
window.document.addEventListener("DOMContentLoaded", function (event) {
  const toggleBodyColorMode = (bsSheetEl) => {
    const mode = bsSheetEl.getAttribute("data-mode");
    const bodyEl = window.document.querySelector("body");
    if (mode === "dark") {
      bodyEl.classList.add("quarto-dark");
      bodyEl.classList.remove("quarto-light");
    } else {
      bodyEl.classList.add("quarto-light");
      bodyEl.classList.remove("quarto-dark");
    }
  }
  const toggleBodyColorPrimary = () => {
    const bsSheetEl = window.document.querySelector("link#quarto-bootstrap");
    if (bsSheetEl) {
      toggleBodyColorMode(bsSheetEl);
    }
  }
  toggleBodyColorPrimary();  
  const icon = "";
  const anchorJS = new window.AnchorJS();
  anchorJS.options = {
    placement: 'right',
    icon: icon
  };
  anchorJS.add('.anchored');
  const clipboard = new window.ClipboardJS('.code-copy-button', {
    target: function(trigger) {
      return trigger.previousElementSibling;
    }
  });
  clipboard.on('success', function(e) {
    // button target
    const button = e.trigger;
    // don't keep focus
    button.blur();
    // flash "checked"
    button.classList.add('code-copy-button-checked');
    var currentTitle = button.getAttribute("title");
    button.setAttribute("title", "Copied!");
    let tooltip;
    if (window.bootstrap) {
      button.setAttribute("data-bs-toggle", "tooltip");
      button.setAttribute("data-bs-placement", "left");
      button.setAttribute("data-bs-title", "Copied!");
      tooltip = new bootstrap.Tooltip(button, 
        { trigger: "manual", 
          customClass: "code-copy-button-tooltip",
          offset: [0, -8]});
      tooltip.show();    
    }
    setTimeout(function() {
      if (tooltip) {
        tooltip.hide();
        button.removeAttribute("data-bs-title");
        button.removeAttribute("data-bs-toggle");
        button.removeAttribute("data-bs-placement");
      }
      button.setAttribute("title", currentTitle);
      button.classList.remove('code-copy-button-checked');
    }, 1000);
    // clear code selection
    e.clearSelection();
  });
  function tippyHover(el, contentFn) {
    const config = {
      allowHTML: true,
      content: contentFn,
      maxWidth: 500,
      delay: 100,
      arrow: false,
      appendTo: function(el) {
          return el.parentElement;
      },
      interactive: true,
      interactiveBorder: 10,
      theme: 'quarto',
      placement: 'bottom-start'
    };
    window.tippy(el, config); 
  }
  const noterefs = window.document.querySelectorAll('a[role="doc-noteref"]');
  for (var i=0; i<noterefs.length; i++) {
    const ref = noterefs[i];
    tippyHover(ref, function() {
      // use id or data attribute instead here
      let href = ref.getAttribute('data-footnote-href') || ref.getAttribute('href');
      try { href = new URL(href).hash; } catch {}
      const id = href.replace(/^#\/?/, "");
      const note = window.document.getElementById(id);
      return note.innerHTML;
    });
  }
  const findCites = (el) => {
    const parentEl = el.parentElement;
    if (parentEl) {
      const cites = parentEl.dataset.cites;
      if (cites) {
        return {
          el,
          cites: cites.split(' ')
        };
      } else {
        return findCites(el.parentElement)
      }
    } else {
      return undefined;
    }
  };
  var bibliorefs = window.document.querySelectorAll('a[role="doc-biblioref"]');
  for (var i=0; i<bibliorefs.length; i++) {
    const ref = bibliorefs[i];
    const citeInfo = findCites(ref);
    if (citeInfo) {
      tippyHover(citeInfo.el, function() {
        var popup = window.document.createElement('div');
        citeInfo.cites.forEach(function(cite) {
          var citeDiv = window.document.createElement('div');
          citeDiv.classList.add('hanging-indent');
          citeDiv.classList.add('csl-entry');
          var biblioDiv = window.document.getElementById('ref-' + cite);
          if (biblioDiv) {
            citeDiv.innerHTML = biblioDiv.innerHTML;
          }
          popup.appendChild(citeDiv);
        });
        return popup.innerHTML;
      });
    }
  }
});
</script>
</div> <!-- /content -->



</body></html>